<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARKSCRIPT AI</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .font-premium { font-family: 'Poppins', sans-serif; }
        .allow-copy {
            -webkit-user-select: text; /* Safari */
            -moz-user-select: text; /* Firefox */
            -ms-user-select: text; /* IE 10+ */
            user-select: text; /* Standard syntax */
        }
        .no-copy {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        .sidebar-btn { 
            transition: all 0.2s ease-in-out; 
            color: #4b5563;
        }
        .sidebar-btn:hover { 
            background-color: #e5e7eb;
            color: #111827;
        }
        .sidebar-btn-active { 
            background-color: #3b82f6;
            color: white; 
            font-weight: 600; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .sidebar-divider {
            padding: 8px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .auth-container {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .form-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-input:focus-visible {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .primary-btn {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .primary-btn:hover {
            background-color: #2563eb;
        }
        .secondary-link { color: #3b82f6; }
        .secondary-link:hover { text-decoration: underline; }
        .card {
             background-color: #ffffff;
             border: 1px solid #e5e7eb;
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .copy-btn.copied, .prompt-copy-btn.copied { background-color: #10b981 !important; color: white !important; }
        .prompt-card.copied {
            background-color: #e6fef2;
            border-left-color: #10b981;
        }
        #log-bar {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Premium Progress Modal */
        #progress-circle-bg { stroke: #e5e7eb; }
        #progress-circle {
            stroke: #3b82f6;
            transition: stroke-dashoffset 0.5s ease-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        @keyframes pulse-wait {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .pulsing-wait {
            animation: pulse-wait 2s ease-in-out infinite;
        }
        
        /* Success Toast */
        #success-toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out;
            z-index: 10000;
        }
        #success-toast.show {
            bottom: 20px;
        }


        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:focus + .slider { box-shadow: 0 0 1px #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed; left: -100%; top: 0; height: 100%; z-index: 40;
                transition: left 0.3s ease-in-out; width: 288px;
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; }
            #menu-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5); z-index: 30;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Overlay de Manuten√ß√£o -->
    <div id="maintenance-overlay" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center text-center p-4">
        <div class="max-w-md text-white">
            <h2 class="text-3xl font-bold mb-2">Em Manuten√ß√£o</h2>
            <p id="maintenance-message" class="text-gray-300 mb-6">Estamos a realizar melhorias. Voltaremos em breve!</p>
            <button id="logout-from-maintenance" class="bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-4 rounded-lg">Sair</button>
        </div>
    </div>

    <!-- Overlay de An√∫ncio Global -->
    <div id="announcement-overlay" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9998] flex items-center justify-center p-4">
        <div class="max-w-md relative bg-white p-8 rounded-lg shadow-xl text-gray-800">
             <button id="close-announcement-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-blue-500 mb-2">Aviso Importante</h2>
            <p id="announcement-message" class="text-gray-600 whitespace-pre-wrap"></p>
        </div>
    </div>

    <!-- Tela de Ativa√ß√£o Pendente -->
    <div id="activation-container" style="display: none;" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 space-y-4 text-center rounded-xl auth-container">
            <h2 class="text-2xl font-bold text-gray-900">Ativa√ß√£o Pendente</h2>
            <p class="text-gray-600">A sua conta foi registada com sucesso, mas precisa de ser ativada por um administrador.</p>
            <button id="back-to-login" class="text-sm secondary-link font-medium mt-4">Voltar para o Login</button>
        </div>
    </div>

    <!-- Telas de Autentica√ß√£o -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tight text-gray-900">DARKSCRIPT AI</h1>
                <p class="mt-1 text-gray-600">Intelig√™ncia para criadores.</p>
            </div>
            
            <div id="login-container" class="p-8 space-y-6 rounded-xl auth-container">
                <form id="login-form" class="space-y-6">
                    <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                    <input id="login-email" type="email" autocomplete="email" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Email">
                    <input id="login-password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Senha">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <input id="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="remember-me" class="text-gray-600">Lembrar-me</label>
                        </div>
                    </div>
                    <button type="submit" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Entrar</button>
                </form>
                <p class="text-center text-sm text-gray-500">N√£o tem uma conta? <button id="show-register" class="font-medium secondary-link">Registe-se</button></p>
            </div>

            <div id="register-container" class="p-8 space-y-6 rounded-xl auth-container" style="display: none;">
                <form id="register-form" class="space-y-6">
                    <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                    <div>
                        <input id="register-email" type="email" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Seu melhor e-mail">
                        <p class="text-xs text-center text-gray-500 mt-1">Use o mesmo e-mail da sua compra.</p>
                    </div>
                    <input id="register-whatsapp" type="tel" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Seu WhatsApp (com DDD)">
                    <input id="register-password" type="password" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Crie uma senha forte">
                    <button type="submit" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Criar Conta</button>
                </form>
                <p class="text-center text-sm text-gray-500">J√° tem uma conta? <button id="show-login" class="font-medium secondary-link">Fa√ßa login</button></p>
            </div>
        </div>
    </div>
    
    <!-- Modal de Progresso -->
    <div id="progress-modal" style="display: none;" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="card p-8 text-center shadow-2xl w-full max-w-md rounded-2xl">
            <div class="relative w-24 h-24 mx-auto mb-6">
                 <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle id="progress-circle-bg" stroke-width="8" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="progress-circle" stroke-width="8" stroke-linecap="round" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <div id="progress-percentage" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-blue-600">0%</div>
            </div>
             <p id="progress-phrase" class="font-premium text-lg text-gray-700 font-medium h-12 flex items-center justify-center"></p>
        </div>
    </div>
    
    <!-- Conte√∫do da Aplica√ß√£o -->
    <div id="app-container" style="display: none;" class="h-screen bg-gray-100">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white flex-shrink-0 flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-200 flex items-center gap-2 h-16">
                 <span class="text-2xl">üß†</span>
                 <span class="text-xl font-bold tracking-tight text-gray-900">DARKSCRIPT AI</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-2"></nav>
            <div class="p-4 border-t border-gray-200">
                <div class="p-2 rounded-lg bg-gray-100">
                    <p class="text-sm font-medium text-gray-800 truncate" id="user-email-display"></p>
                </div>
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-3 py-2 mt-2 rounded-lg text-gray-600 hover:bg-gray-200 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b border-gray-200 flex items-center h-16">
                <button id="open-menu-btn" class="text-2xl text-gray-600">‚ò∞</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg text-gray-900"></h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-8 overflow-y-auto"></main>
            <footer id="log-bar" class="p-2 text-xs text-center flex items-center justify-center h-8 border-t border-gray-200">
                <span id="log-message">Bem-vindo!</span>
            </footer>
        </div>
    </div>
    
    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmation-modal" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9997] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 id="confirmation-title" class="text-lg font-bold text-gray-900"></h3>
            <p id="confirmation-message" class="text-gray-600 my-4"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast de Sucesso -->
     <div id="success-toast" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="success-toast-message"></span>
    </div>

    <!-- API Key Alert Modal -->
    <div id="api-alert-modal" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9997] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900">A√ß√£o Necess√°ria</h3>
            <p class="text-gray-600 my-2">Nenhuma chave de API foi encontrada. A plataforma precisa de pelo menos uma chave (OpenAI ou Gemini) para funcionar.</p>
            <p class="text-xs text-gray-500 mb-6">Este aviso s√≥ aparecer√° uma vez por sess√£o.</p>
            <div class="flex justify-center gap-4">
                <button id="close-api-alert-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Fechar</button>
                <button id="go-to-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Configurar API</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Update Modal -->
    <div id="whatsapp-update-modal" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <div id="whatsapp-form-container">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V8z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Atualize seu Contato</h3>
                <p class="text-gray-600 my-2">Para garantir o melhor suporte e acesso a novidades, por favor, confirme seu n√∫mero de WhatsApp.</p>
                <form id="whatsapp-update-form" class="mt-4 space-y-4">
                    <input id="update-whatsapp-input" type="tel" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Seu WhatsApp (com DDD)">
                    <div id="whatsapp-update-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                    <button type="submit" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Salvar e Continuar</button>
                </form>
            </div>
            <div id="whatsapp-success-container" style="display: none;">
                 <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                     <svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                 </div>
                <h2 class="text-2xl font-bold text-gray-800">DarkScript Liberado!</h2>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9998] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Editar Utilizador</h3>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label for="edit-user-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="edit-user-email" type="email" required class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="edit-user-whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label>
                    <input id="edit-user-whatsapp" type="tel" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                </div>
                <div id="edit-user-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-edit-btn" type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button id="save-edit-btn" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    // --- Global State Management ---
    let appState = { 
        currentUser: null,
        adminPanel: {
            active: { currentPage: 1, limit: 10 },
            pending: { currentPage: 1, limit: 10 }
        },
        progressInterval: null,
        phraseInterval: null,
        toastTimeout: null,
    };
    
    // --- Utility Functions ---
    const showScreen = (screenId) => {
        ['auth-section', 'activation-container', 'app-container', 'maintenance-overlay'].forEach(id => {
            document.getElementById(id).style.display = (id === screenId) ? 'flex' : 'none';
        });
    };
    
    const showProgressModal = () => {
        const phrases = [
            "DarkScript est√° forjando seu pr√≥ximo roteiro viral...",
            "Grandes canais come√ßaram com um √∫nico script. O seu est√° a caminho.",
            "Analisando os segredos do algoritmo para voc√™...",
            "A consist√™ncia √© a chave. Continue criando.",
            "Cada roteiro √© um passo em dire√ß√£o ao seu sucesso.",
            "Transformando sua ideia em um roteiro magn√©tico...",
            "Prepare-se para cativar sua audi√™ncia."
        ];
        const phraseEl = document.getElementById('progress-phrase');
        const circleEl = document.getElementById('progress-circle');
        const percentageEl = document.getElementById('progress-percentage');
        const radius = circleEl.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;

        circleEl.style.strokeDasharray = `${circumference} ${circumference}`;
        
        let phraseIndex = 0;
        phraseEl.textContent = phrases[phraseIndex];
        
        appState.phraseInterval = setInterval(() => {
            phraseIndex = (phraseIndex + 1) % phrases.length;
            phraseEl.textContent = phrases[phraseIndex];
        }, 3500);

        let progress = 0;
        percentageEl.textContent = `0%`;
        circleEl.style.strokeDashoffset = circumference;
        appState.progressInterval = setInterval(() => {
            if (progress < 95) { 
                progress += 1;
            } else {
                circleEl.classList.add('pulsing-wait'); 
            }
            const offset = circumference - (progress / 100) * circumference;
            circleEl.style.strokeDashoffset = offset;
            percentageEl.textContent = `${Math.round(progress)}%`;
        }, 150);

        document.getElementById('progress-modal').style.display = 'flex';
    };

    const hideProgressModal = () => {
        clearInterval(appState.progressInterval);
        clearInterval(appState.phraseInterval);
        appState.progressInterval = null;
        appState.phraseInterval = null;
        
        const circleEl = document.getElementById('progress-circle');
        const percentageEl = document.getElementById('progress-percentage');
        const radius = circleEl.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        
        circleEl.classList.remove('pulsing-wait');
        circleEl.style.strokeDashoffset = 0; // Animate to 100%
        percentageEl.textContent = `100%`;

        setTimeout(() => {
            document.getElementById('progress-modal').style.display = 'none';
        }, 500);
    };

    const showSuccessToast = (message) => {
        const toast = document.getElementById('success-toast');
        document.getElementById('success-toast-message').textContent = message;
        
        if (appState.toastTimeout) clearTimeout(appState.toastTimeout);

        toast.classList.add('show');
        appState.toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    };

    const addToLog = (message, isError = false) => { 
        const logBar = document.getElementById('log-bar');
        document.getElementById('log-message').textContent = message; 
        logBar.style.backgroundColor = isError ? '#fee2e2' : '#dbeafe'; // red-100 or blue-100
        logBar.style.color = isError ? '#991b1b' : '#1e40af'; // red-800 or blue-800
    };
    
    const downloadFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccessToast(`${filename} baixado!`);
    };


    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        const token = localStorage.getItem('authToken');
        const options = { 
            method, 
            headers: { 'Content-Type': 'application/json' } 
        };
        if (token) options.headers['Authorization'] = `Bearer ${token}`;
        if (body) options.body = JSON.stringify(body);
        
        const response = await fetch(endpoint, options);
        const data = await response.json().catch(() => null);
        
        if (!response.ok) {
            if ((response.status === 401 || response.status === 403) && endpoint !== '/api/login') {
                 if (!data || !data.message || !data.message.includes('ativada')) handleLogout();
            }
            throw new Error(data ? data.message : 'Ocorreu um erro desconhecido.');
        }
        return data;
    }

    // --- Authentication & Screen Navigation ---
    async function handleLogin(e) {
        e.preventDefault();
        document.getElementById('login-feedback').textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;
        try {
            const response = await apiRequest('/api/login', 'POST', { email, password, rememberMe });
            localStorage.setItem('authToken', response.token);
            appState.currentUser = response.user;

            const appStatus = await apiRequest('/api/status', 'GET');
            
            if (appStatus && appStatus.maintenance && appStatus.maintenance.is_on && appState.currentUser.role !== 'admin') {
                showMaintenanceMode(appStatus.maintenance.message);
            } else {
                await initializeApp(appStatus ? appStatus.announcement : null);
            }

        } catch (error) {
            if (error.message.includes('ativada')) {
                showScreen('activation-container');
            } else {
                document.getElementById('login-feedback').textContent = error.message;
            }
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const feedbackEl = document.getElementById('register-feedback');
        feedbackEl.textContent = '';
        const email = document.getElementById('register-email').value;
        const whatsapp = document.getElementById('register-whatsapp').value;
        const password = document.getElementById('register-password').value;

        const whatsappRegex = /^\+?[1-9]\d{1,14}$/;
        const cleanedWhatsapp = whatsapp.replace(/\D/g, ''); 

        if (!whatsappRegex.test(cleanedWhatsapp) || cleanedWhatsapp.length < 10) {
            feedbackEl.textContent = 'Por favor, insira um n√∫mero de WhatsApp v√°lido.';
            return;
        }
        
        try {
            await apiRequest('/api/register', 'POST', { email, password, whatsapp });
            showScreen('activation-container');
        } catch (error)
        {
            feedbackEl.textContent = error.message;
        }
    }
    
    function handleLogout() {
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('apiAlertShown');
        appState.currentUser = null;
        showScreen('auth-section');
        document.getElementById('login-form').reset();
    }
    
    function showMaintenanceMode(message) {
        document.getElementById('maintenance-message').textContent = message || 'Estamos a realizar melhorias na plataforma. Voltaremos em breve!';
        showScreen('maintenance-overlay');
    }

    function showAnnouncement(announcement) {
        if (!announcement || !announcement.message) return;
        const seenAnnouncements = JSON.parse(localStorage.getItem('seenAnnouncements') || '[]');
        const announcementHash = announcement.message.substring(0, 50);
        if (seenAnnouncements.includes(announcementHash)) return;

        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const linkedMessage = announcement.message.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-500 hover:underline">$1</a>');
        document.getElementById('announcement-message').innerHTML = linkedMessage;
        document.getElementById('announcement-overlay').style.display = 'flex';

        document.getElementById('close-announcement-btn').onclick = () => {
            document.getElementById('announcement-overlay').style.display = 'none';
            seenAnnouncements.push(announcementHash);
            localStorage.setItem('seenAnnouncements', JSON.stringify(seenAnnouncements));
        };
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        document.getElementById('confirmation-modal').style.display = 'flex';

        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        const confirmHandler = () => { onConfirm(); hideConfirmationModal(); };
        const cancelHandler = () => hideConfirmationModal();
        
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        
        document.getElementById('confirm-btn').addEventListener('click', confirmHandler);
        document.getElementById('cancel-btn').addEventListener('click', cancelHandler);
    }
    const hideConfirmationModal = () => document.getElementById('confirmation-modal').style.display = 'none';

    // --- Anti-Copy System ---
    function activateAntiCopy() {
        document.body.classList.add('no-copy');
        document.addEventListener('contextmenu', event => {
            event.preventDefault();
            addToLog('A√ß√£o desativada para proteger o conte√∫do.', true);
        });
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key.toLowerCase() === 'c' || e.key.toLowerCase() === 'v')) {
                return;
            }
            if (e.ctrlKey && ['u', 's', 'a', 'x'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                addToLog('A√ß√£o desativada para proteger o conte√∫do.', true);
            }
            if (e.key === 'F12') {
                e.preventDefault();
                addToLog('A√ß√£o desativada para proteger o conte√∫do.', true);
            }
        });
    }
    
    // --- API Alert ---
    async function checkAndShowApiAlert() {
        if (sessionStorage.getItem('apiAlertShown')) {
            return;
        }
        try {
            const settings = await apiRequest('/api/settings', 'GET');
            const hasOpenAI = settings.openai && settings.openai.trim() !== '';
            const hasGemini = Array.isArray(settings.gemini) && settings.gemini.some(key => key && key.trim() !== '');
            
            if (!hasOpenAI && !hasGemini) {
                document.getElementById('api-alert-modal').style.display = 'flex';
                sessionStorage.setItem('apiAlertShown', 'true');
            }
        } catch (error) {
            console.error("Erro ao verificar as configura√ß√µes de API:", error);
        }
    }

    // --- WhatsApp Popup ---
    async function checkAndShowWhatsappPopup() {
        if (!appState.currentUser || appState.currentUser.whatsapp) {
            return; 
        }

        const modal = document.getElementById('whatsapp-update-modal');
        const form = document.getElementById('whatsapp-update-form');
        const feedbackEl = document.getElementById('whatsapp-update-feedback');
        const formContainer = document.getElementById('whatsapp-form-container');
        const successContainer = document.getElementById('whatsapp-success-container');

        modal.style.display = 'flex';

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            feedbackEl.textContent = '';
            const whatsappInput = document.getElementById('update-whatsapp-input');
            const whatsapp = whatsappInput.value;

            const whatsappRegex = /^\+?[1-9]\d{1,14}$/;
            const cleanedWhatsapp = whatsapp.replace(/\D/g, '');

            if (!whatsappRegex.test(cleanedWhatsapp) || cleanedWhatsapp.length < 10) {
                feedbackEl.textContent = 'Por favor, insira um n√∫mero de WhatsApp v√°lido.';
                return;
            }

            try {
                await apiRequest('/api/user/whatsapp', 'PUT', { whatsapp });
                
                appState.currentUser.whatsapp = whatsapp;
                formContainer.style.display = 'none';
                successContainer.style.display = 'block';

                setTimeout(() => {
                    modal.style.display = 'none';
                }, 2000);

            } catch (error) {
                feedbackEl.textContent = error.message || 'Ocorreu um erro. Tente novamente.';
            }
        });
    }


    // --- App Initialization ---
    async function initializeApp(initialAnnouncement = null) {
        if (!appState.currentUser) return;
        
        document.getElementById('user-email-display').textContent = appState.currentUser.email;
        showScreen('app-container');
        
        buildSidebar();
        renderTabContent('script-writer');
        activateAntiCopy();
        
        if(initialAnnouncement) showAnnouncement(initialAnnouncement);
        
        await checkAndShowApiAlert();
        await checkAndShowWhatsappPopup();
    }

    // --- UI Building ---
    function buildSidebar() {
        const sidebarNav = document.getElementById('sidebar-nav');
        const navItems = [
            { type: 'divider', label: 'Cria√ß√£o e Conte√∫do' },
            { id: 'script-writer', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z', label: 'Criador de Roteiro' },
            { id: 'viral-titles', icon: 'M15 15l-2 5L9 9l5-2 2 5z', label: 'T√≠tulos Virais' },
            { id: 'scene-prompts', icon: 'M15.5 4l-3.5 3.5M15.5 4a2.121 2.121 0 00-3-3L10 3.5M15.5 4v.5A2.5 2.5 0 0113 7M3 14l3-3m0 0l3 3m-3-3v10a2 2 0 002 2h3.5', label: 'Prompts para Cenas'},
            { id: 'thumbnail-prompts', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'Otimiza√ß√£o e Gest√£o' },
            { id: 'srt-converter', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4', label: 'Conversor de SRT' },
            { id: 'text-divider', icon: 'M4 6h16M4 12h16M4 18h7', label: 'Divisor de Texto' },
            { type: 'divider', label: 'Sistema' },
            { id: 'settings', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z', label: 'Configura√ß√µes' },
            { id: 'faq', icon: 'M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4c-1.742 0-3.223-.835-3.772-2H6.5v2H4.5v-2H2.728a1 1 0 010-2h1.772V7H6.5v2h1.728zM12 18a6 6 0 100-12 6 6 0 000 12z', label: 'FAQ' },
        ];
        if (appState.currentUser && appState.currentUser.role === 'admin') {
            navItems.push({ 
                id: 'admin', 
                icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-1.781-4.121M12 11a4 4 0 11-8 0 4 4 0 018 0z', 
                label: 'Painel Admin' 
            });
        }
        const createIcon = (path) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="${path}" /></svg>`;
        sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="sidebar-divider pt-4 pb-1">${item.label}</div>`;
            }
            return `<div class="px-4"><button class="sidebar-btn ${item.id === 'script-writer' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg" data-tab="${item.id}"><span>${createIcon(item.icon)}</span><span>${item.label}</span></button></div>`
        }).join('');
    }
    
    // --- Tools and Handlers ---
    const createCopyButton = (text, specificClass = '') => `<button class="copy-btn ${specificClass}" data-copy-text="${encodeURIComponent(text)}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>`;
    
    const getScoreColor = (score) => score >= 80 ? 'bg-blue-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-blue-600' : score >= 50 ? 'text-yellow-600' : 'text-red-600';
    
    const renderScoreCard = (title, mainScore, subScores, suggestion = '') => {
        const intMainScore = Math.round(mainScore || 0);
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            const cappedValue = Math.min(100, Math.round(value || 0));
            return `<div class="mb-2">
                        <div class="flex justify-between items-center text-sm mb-1 gap-2">
                            <span class="text-gray-600 truncate" title="${key}">${key}</span>
                            <span class="font-semibold text-gray-700 flex-shrink-0">${cappedValue}/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="h-1.5 rounded-full ${getScoreColor(cappedValue)}" style="width: ${cappedValue}%;"></div>
                        </div>
                    </div>`;
        }).join('');
        const suggestionHtml = suggestion ? `<p class="text-xs text-gray-500 mt-3 pt-3 border-t"><strong class="text-gray-600">Virada de Chave:</strong> ${suggestion}</p>` : '';

        return `<div class="card p-4 w-full flex-shrink-0 min-w-0">
                    <h4 class="font-semibold text-gray-800 mb-2 truncate" title="${title}">${title}</h4>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span>
                            <span class="text-gray-500 text-sm">/ 100</span>
                        </div>
                    </div>
                    ${subScoresHtml}
                    ${suggestionHtml}
                </div>`;
    };

    const getLegendForTool = (toolId) => {
        const legends = {
            'script-writer': `<h4 class="font-semibold text-gray-800 mb-2">üí° Entendendo as M√©tricas</h4><ul class="space-y-2 text-sm text-gray-600 list-disc list-inside"><li><strong>Potencial de Reten√ß√£o:</strong> Mede a capacidade do roteiro de manter o espectador assistindo.</li><li><strong>Clareza da Mensagem:</strong> Avalia qu√£o f√°cil √© entender a ideia central do v√≠deo.</li><li><strong>Potencial Viral:</strong> Estima a probabilidade do conte√∫do ser amplamente compartilhado.</li></ul>`,
            'thumbnail-prompts': `<h4 class="font-semibold text-gray-800 mb-2">üí° Entendendo as M√©tricas</h4><ul class="space-y-2 text-sm text-gray-600 list-disc list-inside"><li><strong>Potencial de CTR:</strong> Estimativa do poder de atra√ß√£o do clique na thumbnail gerada.</li><li><strong>Virada de Chave:</strong> A principal melhoria ou conceito aplicado no prompt.</li></ul>`,
            'viral-titles': `<h4 class="font-semibold text-gray-800 mb-2">üí° Entendendo a Ferramenta</h4><p class="text-sm text-gray-600">Esta ferramenta unificada pode gerar tanto <strong>T√≠tulos Prontos</strong> (com an√°lise de pontua√ß√£o) quanto <strong>Estruturas de T√≠tulos</strong> (modelos para voc√™ preencher). Selecione o que precisa e deixe a IA fazer a m√°gica!</p>`
        };
        const legendHtml = legends[toolId] || '';
        if (!legendHtml) return '';
        return `<div class="mt-6 text-sm card p-4">${legendHtml}</div>`;
    };

    async function callAIModel(prompt, schema = null) {
        showProgressModal();
        addToLog('Comunicando com a IA...');
        try {
            const result = await apiRequest('/api/generate', 'POST', { prompt, schema });
            addToLog(`An√°lise conclu√≠da via ${result.apiSource}.`);
            return result.data;
        } catch (error) {
            addToLog(`Erro na API: ${error.message}`, true);
            alert(`Erro na API: ${error.message}`);
            throw error;
        } finally {
            hideProgressModal();
        }
    }
    
    const tools = {
        "script-writer": { 
            title: "Criador de Roteiro", 
            desc: "Gere roteiros envolventes e otimizados para o seu canal.", 
            content: `<div class="max-w-3xl mx-auto">
                        <form id="script-writer-form-container" class="card p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="script-niche" class="text-sm font-medium text-gray-700">Nicho do Canal</label>
                                    <input type="text" id="script-niche" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: Crimes Reais, Mist√©rios">
                                </div>
                                <div>
                                    <label for="script-audience" class="text-sm font-medium text-gray-700">P√∫blico-Alvo</label>
                                    <input type="text" id="script-audience" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: Jovens adultos, f√£s de suspense">
                                </div>
                            </div>
                            <div>
                                <label for="script-topic" class="text-sm font-medium text-gray-700">Tema do V√≠deo</label>
                                <input type="text" id="script-topic" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: O Mist√©rio do Tri√¢ngulo das Bermudas">
                            </div>
                            <div>
                                <label for="script-trends-term" class="text-sm font-medium text-gray-700">Termo de Pesquisa (Opcional)</label>
                                <input type="text" id="script-trends-term" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: intelig√™ncia artificial, true crime brasil">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="script-duration" class="text-sm font-medium text-gray-700">Dura√ß√£o (min)</label>
                                    <input type="number" id="script-duration" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: 10">
                                </div>
                                <div>
                                    <label for="script-parts" class="text-sm font-medium text-gray-700">Partes</label>
                                    <input type="number" id="script-parts" class="mt-1 w-full px-4 py-3 rounded-lg form-input bg-gray-200" placeholder="Auto" readonly>
                                </div>
                                <div>
                                    <label for="script-lang" class="text-sm font-medium text-gray-700">Idioma</label>
                                    <select id="script-lang" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                        <option value="Portugu√™s (Brasil)">Portugu√™s (Brasil)</option>
                                        <option value="English (US)">Ingl√™s (EUA)</option>
                                        <option value="Spanish (Spain)">Espanhol (Espanha)</option>
                                        <option value="German">Alem√£o</option>
                                        <option value="French">Franc√™s</option>
                                        <option value="Italian">Italiano</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                               <label for="script-tone" class="text-sm font-medium text-gray-700">Tom Narrativo</label>
                               <select id="script-tone" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                   <option value="envolvente e misterioso">Envolvente e Misterioso</option>
                                   <option value="informativo e claro">Informativo e Claro</option>
                                   <option value="c√¥mico e divertido">C√¥mico e Divertido</option>
                                   <option value="s√©rio e formal">S√©rio e Formal</option>
                                   <option value="inspirador e motivacional">Inspirador e Motivacional</option>
                               </select>
                            </div>
                            <div>
                                <label for="script-formula" class="text-sm font-medium text-gray-700">F√≥rmula de Estrutura</label>
                                <select id="script-formula" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                    <option value="" selected disabled>-- Selecione uma F√≥rmula --</option>
                                    <optgroup label="üõ°Ô∏è F√ìRMULA PADR√ÉO">
                                        <option value="universal_safe">UNIVERSAL SAFE (Padr√£o Seguro)</option>
                                    </optgroup>
                                    <optgroup label="‚úùÔ∏è CANAIS CRIST√ÉOS">
                                        <option value="faith_journey">FAITH JOURNEY - crescimento espiritual</option>
                                        <option value="testimony_power">TESTIMONY POWER - testemunhos impactantes</option>
                                        <option value="bible_wisdom">BIBLE WISDOM - estudos b√≠blicos</option>
                                        <option value="gospel_share">GOSPEL SHARE - evangeliza√ß√£o</option>
                                        <option value="praise_story">PRAISE STORY - hist√≥rias de f√©</option>
                                    </optgroup>
                                    <optgroup label="üíî HIST√ìRIAS EMOCIONANTES">
                                        <option value="heart_break">HEART BREAK - narrativas emocionais intensas</option>
                                        <option value="emotional_wave">EMOTIONAL WAVE - drama com build-up emocional</option>
                                        <option value="life_change">LIFE CHANGE - transforma√ß√µes pessoais tocantes</option>
                                    </optgroup>
                                    <optgroup label="üëª TERROR & SUSPENSE">
                                        <option value="fear_factor">FEAR FACTOR - terror psicol√≥gico</option>
                                        <option value="nightmare_mode">NIGHTMARE MODE - horror stories completas</option>
                                        <option value="creepy_truth">CREEPY TRUTH - mist√©rios sombrios</option>
                                        <option value="haunted_real">HAUNTED REAL - paranormal/sobrenatural</option>
                                    </optgroup>
                                    <optgroup label="üèõÔ∏è CIVILIZA√á√ïES ANTIGAS">
                                        <option value="ancient_wisdom">ANCIENT WISDOM - civiliza√ß√µes perdidas</option>
                                        <option value="mystery_past">MYSTERY PAST - enigmas hist√≥ricos</option>
                                        <option value="time_travel">TIME TRAVEL - jornadas hist√≥ricas imersivas</option>
                                        <option value="civilization_rise">CIVILIZATION RISE - ascens√£o e queda de imp√©rios</option>
                                    </optgroup>
                                    <optgroup label="üöó AUTOMOBILISMO & CARROS">
                                        <option value="car_passion">CAR PASSION - paix√£o automotiva</option>
                                        <option value="drive_test">DRIVE TEST - reviews detalhados</option>
                                        <option value="speed_rush">SPEED RUSH - performance/racing</option>
                                        <option value="auto_evolution">AUTO EVOLUTION - hist√≥ria automotiva</option>
                                        <option value="garage_dreams">GARAGE DREAMS - cultura car</option>
                                    </optgroup>
                                    <optgroup label="ü™ê PLANETAS & ESPA√áO">
                                        <option value="space_wonder">SPACE WONDER - explora√ß√£o espacial</option>
                                        <option value="planet_deep">PLANET DEEP - estudos planet√°rios</option>
                                        <option value="cosmic_journey">COSMIC JOURNEY - viagens espaciais</option>
                                        <option value="universe_scale">UNIVERSE SCALE - perspectiva c√≥smica</option>
                                        <option value="alien_search">ALIEN SEARCH - vida extraterrestre</option>
                                    </optgroup>
                                    <optgroup label="üéì EDUCA√á√ÉO & APRENDIZADO">
                                        <option value="teach_master">TEACH MASTER (Conceitos Complexos)</option>
                                        <option value="skill_build">SKILL BUILD (Desenvolvimento de Habilidades)</option>
                                        <option value="concept_clarity">CONCEPT CLARITY (Explica√ß√µes Did√°ticas)</option>
                                    </optgroup>
                                    <optgroup label="üí∞ NEG√ìCIOS & EMPREENDEDORISMO">
                                        <option value="profit_system">PROFIT SYSTEM (Estrat√©gias de Neg√≥cio)</option>
                                        <option value="scale_smart">SCALE SMART (Crescimento)</option>
                                        <option value="mindset_money">MINDSET MONEY (Mentalidade Empresarial)</option>
                                    </optgroup>
                                    <optgroup label="üéØ MARKETING & VENDAS">
                                        <option value="convert_pro">CONVERT PRO (Persuas√£o/Vendas)</option>
                                        <option value="viral_engine">VIRAL ENGINE (Content Marketing)</option>
                                        <option value="authority_build">AUTHORITY BUILD (Personal Branding)</option>
                                    </optgroup>
                                    <optgroup label="üí™ FITNESS & SA√öDE">
                                        <option value="transform_body">TRANSFORM BODY (Transforma√ß√£o F√≠sica)</option>
                                        <option value="fit_fast">FIT FAST (Exerc√≠cios R√°pidos)</option>
                                        <option value="health_hack">HEALTH HACK (Sa√∫de/Wellness)</option>
                                    </optgroup>
                                    <optgroup label="üéÆ ENTRETENIMENTO & GAMING">
                                        <option value="epic_moment">EPIC MOMENT (Gaming Content)</option>
                                        <option value="story_master_game">STORY MASTER (Narrativas)</option>
                                        <option value="react_value">REACT VALUE (Reaction Content)</option>
                                    </optgroup>
                                    <optgroup label="üç≥ CULIN√ÅRIA & LIFESTYLE">
                                        <option value="cook_expert">COOK EXPERT (Receitas)</option>
                                        <option value="taste_journey">TASTE JOURNEY (Food Reviews)</option>
                                        <option value="home_transform">HOME TRANSFORM (Casa/Organiza√ß√£o)</option>
                                    </optgroup>
                                    <optgroup label="üé® ARTE & CRIATIVIDADE">
                                        <option value="create_magic">CREATE MAGIC (Processo Criativo)</option>
                                        <option value="inspire_deep">INSPIRE DEEP (Arte/Design)</option>
                                    </optgroup>
                                    <optgroup label="üî¨ CI√äNCIA & TECNOLOGIA">
                                        <option value="discovery_method">DISCOVERY METHOD (Pesquisa/Ci√™ncia)</option>
                                        <option value="tech_review">TECH REVIEW (Tecnologia)</option>
                                        <option value="future_vision">FUTURE VISION (Inova√ß√£o)</option>
                                    </optgroup>
                                    <optgroup label="üé≠ DRAMA & MIST√âRIO">
                                        <option value="mystery_solver">MYSTERY SOLVER (True Crime)</option>
                                        <option value="reveal_process">REVEAL PROCESS (Investiga√ß√£o)</option>
                                    </optgroup>
                                    <optgroup label="üß† PSICOLOGIA & DESENVOLVIMENTO">
                                        <option value="mindset_shift">MINDSET SHIFT (Mudan√ßa Mental)</option>
                                        <option value="breakthrough_now">BREAKTHROUGH NOW (Supera√ß√£o)</option>
                                        <option value="habit_master">HABIT MASTER (Forma√ß√£o de H√°bitos)</option>
                                    </optgroup>
                                    <optgroup label="üåç VIAGEM & CULTURA">
                                        <option value="travel_deep">TRAVEL DEEP (Viagens)</option>
                                        <option value="culture_immersion">CULTURE IMMERSION (Explora√ß√£o Cultural)</option>
                                    </optgroup>
                                    <optgroup label="üìà FINAN√áAS & INVESTIMENTOS">
                                        <option value="wealth_build">WEALTH BUILD (Constru√ß√£o de Riqueza)</option>
                                        <option value="invest_smart">INVEST SMART (Investimentos)</option>
                                        <option value="money_mastery">MONEY MASTERY (Educa√ß√£o Financeira)</option>
                                    </optgroup>
                                    <optgroup label="üé™ F√ìRMULAS H√çBRIDAS AVAN√áADAS">
                                        <option value="viral_education">VIRAL EDUCATION (Edutainment)</option>
                                        <option value="story_teach">STORY TEACH (Narrativa Educativa)</option>
                                        <option value="comparison_master">COMPARISON MASTER (Reviews/Compara√ß√µes)</option>
                                    </optgroup>
                                </select>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-gray-700">Posi√ß√£o do CTA (Chamada para A√ß√£o)</label>
                                <div class="mt-2 flex items-center space-x-4">
                                    <div class="flex items-center"><input id="cta-inicio" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="cta-inicio" class="ml-2 text-sm">In√≠cio</label></div>
                                    <div class="flex items-center"><input id="cta-meio" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked><label for="cta-meio" class="ml-2 text-sm">Meio</label></div>
                                    <div class="flex items-center"><input id="cta-final" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="cta-final" class="ml-2 text-sm">Final</label></div>
                                </div>
                             </div>
                            <div class="flex items-center justify-between flex-wrap gap-4">
                               <div class="flex items-center gap-2">
                                 <input type="checkbox" id="script-narration" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <label for="script-narration" class="text-sm text-gray-700">Apenas Narra√ß√£o (para Voice Over)</label>
                               </div>
                               <div class="flex items-center gap-2">
                                 <input type="checkbox" id="include-affiliate-product" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <label for="include-affiliate-product" class="text-sm text-gray-700 font-medium">Incluir produto de afilia√ß√£o</label>
                               </div>
                            </div>
                            <div id="affiliate-product-container" style="display: none;">
                               <label for="affiliate-product-description" class="text-sm font-medium text-gray-700">Descreva o Produto</label>
                               <input type="text" id="affiliate-product-description" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: um curso online sobre marketing digital">
                            </div>
                            <button id="generate-script" type="button" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Roteiro</button>
                        </form>
                        <div id="legend-container" class="mt-6"></div>
                        <div id="output" class="mt-6 allow-copy"></div>
                        <div id="script-pagination-controls" class="flex justify-center items-center gap-4 mt-4"></div>
                        <div id="script-history-container" class="mt-8"></div>
                      </div>` 
        },
        "viral-titles": {
            title: "T√≠tulos Virais",
            desc: "Crie t√≠tulos e estruturas magn√©ticas para multiplicar suas visualiza√ß√µes.",
            content: `<div class="max-w-3xl mx-auto">
                        <div class="card p-6 space-y-4">
                            <input type="text" id="viral-topic" class="w-full px-4 py-3 rounded-lg form-input" placeholder="Tema Central (ex: como investir em a√ß√µes)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="viral-type" class="text-sm font-medium text-gray-700">Tipo de Gera√ß√£o</label>
                                    <select id="viral-type" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                        <option value="titles">Gerar T√≠tulos Prontos</option>
                                        <option value="structures">Gerar Estruturas de T√≠tulos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="viral-lang" class="text-sm font-medium text-gray-700">Idioma</label>
                                    <select id="viral-lang" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                        <option value="Portugu√™s (Brasil)">Portugu√™s (Brasil)</option>
                                        <option value="Ingl√™s">Ingl√™s</option>
                                        <option value="Espanhol">Espanhol</option>
                                    </select>
                                </div>
                            </div>
                            <button id="generate-viral-content" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Conte√∫do</button>
                        </div>
                        <div id="legend-container" class="mt-6"></div>
                        <div id="output" class="mt-6 space-y-4 allow-copy"></div>
                        <button id="generate-more-viral-content" style="display:none;" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Gerar Mais</button>
                    </div>`
        },
        "scene-prompts": { title: "Prompts para Cenas", desc: "Gere prompts de imagem para o seu roteiro, de forma autom√°tica ou manual.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><div class="relative"><textarea id="scene-text" class="w-full h-40 px-4 py-3 rounded-lg form-input" placeholder="Cole o roteiro completo aqui..."></textarea><div id="scene-word-counter" class="absolute bottom-2 right-3 text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">0 palavras</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="scene-platform" class="w-full px-4 py-3 rounded-lg form-input"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Wisk">Wisk</option><option value="Nano Banana">Nano Banana</option><option value="Flux">Flux</option><option value="Freepik">Freepik</option></select><select id="generation-mode" class="w-full px-4 py-3 rounded-lg form-input"><option value="auto">Gera√ß√£o Autom√°tica de Cenas</option><option value="manual">Gera√ß√£o Manual por Palavras</option></select></div><div id="manual-options" class="hidden items-center gap-2"><label class="text-sm">Gerar a cada</label><input type="number" value="100" id="scene-word-count" class="form-input w-20 text-center"><label class="text-sm">palavras.</label><span id="scene-preview" class="text-sm font-medium text-blue-600"></span></div><button id="generate-scene-prompts" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Prompts de Cena</button></div><div id="output" class="mt-6 space-y-4 allow-copy"></div><div id="scene-pagination-controls" class="flex justify-center items-center gap-4 mt-4"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 rounded-lg form-input" placeholder="T√≠tulo do V√≠deo"><select id="thumb-platform" class="w-full px-4 py-3 rounded-lg form-input"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Wisk">Wisk</option><option value="Nano Banana">Nano Banana</option><option value="Flux">Flux</option><option value="Freepik">Freepik</option></select><button id="generate-prompts" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Prompts</button></div><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6 space-y-4 allow-copy"></div><div id="thumb-actions" class="mt-4"></div><button id="generate-more-prompts" style="display:none;" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Gerar Mais</button></div>` },
        "srt-converter": { title: "Conversor de SRT", desc: "Converta texto para o formato de legenda .SRT.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><textarea id="srt-input-text" class="w-full h-40 px-4 py-3 rounded-lg form-input" placeholder="Cole o texto completo aqui..."></textarea><div class="flex items-center gap-4 justify-center"><label for="srt-char-limit" class="text-sm font-medium text-gray-700">Limite de Caracteres (Autom√°tico: 500):</label><input type="number" id="srt-char-limit" class="form-input w-24 text-center" value="500"></div><button id="convert-to-srt" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Converter para SRT</button></div><div id="output" class="mt-6 allow-copy"></div></div>` },
        "text-divider": { title: "Divisor de Texto", desc: "Analise seu roteiro e divida-o em partes menores para facilitar a narra√ß√£o.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6"><div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6"><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Palavras</p><p id="word-count" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Caracteres</p><p id="char-count" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Tempo de Narra√ß√£o</p><p id="time-estimate" class="text-3xl font-bold">00:00</p></div></div><textarea id="text-divider-input" class="w-full h-40 px-4 py-3 rounded-lg form-input mb-4" placeholder="Cole o roteiro completo aqui..."></textarea><div class="flex flex-wrap items-center justify-center gap-4"><label for="split-chunk-size" class="text-sm">Dividir a cada</label><input type="number" id="split-chunk-size" class="px-3 py-2 rounded-lg form-input w-24 text-center" value="150"><select id="split-chunk-type" class="px-3 py-2 rounded-lg form-input"><option value="word">palavras</option><option value="char">caracteres</option></select><button id="split-text-btn" class="py-2 px-6 rounded-lg font-semibold primary-btn">Dividir</button></div></div><div id="output" class="mt-6 space-y-4 allow-copy"></div></div>` },
        "settings": { title: "Configura√ß√µes", desc: "Gerencie e valide as suas chaves de API.", content: `<div class="max-w-3xl mx-auto space-y-6">
            <div id="settings-card" class="card p-6 space-y-6">
                <h3 class="text-lg font-semibold">Chaves de API</h3>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">OpenAI API Key (Preferencial) <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline text-xs">(obter)</a></label><input type="password" id="openai-key" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div>
                    <hr/>
                    <div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Principal) <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline text-xs">(obter)</a></label><input type="password" id="gemini-key-1" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Reserva 1)</label><input type="password" id="gemini-key-2" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Reserva 2)</label><input type="password" id="gemini-key-3" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div>
                </div>
                <button id="save-settings" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Salvar Configura√ß√µes</button>
                <div id="settings-feedback" class="mt-2 text-sm"></div>
            </div>
            <div class="mt-6 space-y-4">
                <details class="bg-gray-50 rounded-lg p-4 border">
                    <summary class="font-semibold cursor-pointer text-gray-800 list-none flex justify-between items-center">
                        Como obter uma API Key do Gemini? (Tutorial R√°pido)
                        <svg class="w-5 h-5 transition-transform transform details-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="mt-4 text-sm text-gray-600 space-y-2 prose prose-sm max-w-none">
                        <p>Siga estes passos para criar sua chave de API gratuita no Google AI Studio:</p>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Acesse o <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-medium">Google AI Studio</a> e fa√ßa login com sua conta Google.</li>
                            <li>No menu √† esquerda, clique em <strong>"Get API key"</strong>.</li>
                            <li>Clique no bot√£o <strong>"Create API key in new project"</strong>.</li>
                            <li>Aguarde um instante e sua chave ser√° gerada. Copie a chave (uma longa sequ√™ncia de letras e n√∫meros).</li>
                            <li>Cole a chave no campo "Gemini API Key (Principal)" acima e salve as configura√ß√µes.</li>
                        </ol>
                        <p>Pronto! Agora a plataforma pode usar o poder do Gemini para gerar seus roteiros.</p>
                    </div>
                </details>
                <details class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                    <summary class="font-semibold cursor-pointer text-yellow-800 list-none flex justify-between items-center">
                        N√£o conseguiu? Siga este tutorial alternativo (Google Cloud)
                        <svg class="w-5 h-5 transition-transform transform details-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="mt-4 text-sm text-yellow-700 space-y-2 prose prose-sm max-w-none">
                        <p>Algumas contas Google precisam primeiro de um projeto no Google Cloud. Se o m√©todo r√°pido n√£o funcionou, siga estes passos:</p>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Acesse o <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline font-medium">Google Cloud Console</a>.</li>
                            <li>No topo da p√°gina, clique no seletor de projetos (ao lado do logo do Google Cloud) e depois em <strong>"NOVO PROJETO"</strong>.</li>
                            <li>D√™ um nome ao seu projeto (ex: "DarkScript-AI-Project") e clique em <strong>"CRIAR"</strong>.</li>
                            <li>Na barra de busca no topo, procure por "Generative Language API" e selecione-a. Clique em <strong>"ATIVAR"</strong> (ENABLE).</li>
                            <li>Agora, volte para o <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-medium">Google AI Studio</a>.</li>
                            <li>Clique em <strong>"Get API key"</strong> novamente. Desta vez, voc√™ poder√° selecionar o projeto que acabou de criar para gerar sua chave.</li>
                            <li>Copie a chave e cole no campo "Gemini API Key (Principal)" acima.</li>
                        </ol>
                    </div>
                </details>
            </div>
            <style>details[open] .details-arrow { transform: rotate(180deg); }</style>
        </div>` },
        "admin": { title: "Painel Administrativo", desc: "Gerir utilizadores e configura√ß√µes da aplica√ß√£o.", content: `<div id="admin-container" class="space-y-6"></div>` },
        "faq": {
            title: "FAQ - Perguntas Frequentes",
            desc: "Tudo o que voc√™ precisa saber para extrair o m√°ximo da DarkScript AI.",
            content: `
                <div class="max-w-3xl mx-auto space-y-4">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">O que √© a DarkScript AI?</h3>
                        <p class="mt-2 text-gray-600">A DarkScript AI √© uma su√≠te de ferramentas projetada para criadores de conte√∫do, focada em otimizar e acelerar o processo de cria√ß√£o de v√≠deos, desde a concep√ß√£o do roteiro at√© a publica√ß√£o.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Como funciona o Criador de Roteiro?</h3>
                        <p class="mt-2 text-gray-600">Esta √© a nossa ferramenta principal. Voc√™ insere informa√ß√µes sobre seu canal, o tema do v√≠deo e escolhe uma "F√≥rmula de Estrutura". Temos dezenas de f√≥rmulas testadas para nichos espec√≠ficos (de terror a canais crist√£os) para maximizar o impacto. Se estiver em d√∫vida, comece com a <strong>F√≥rmula UNIVERSAL SAFE</strong>, que garante 80% de efic√°cia para qualquer tipo de conte√∫do. A IA ent√£o gera um roteiro completo, otimizado para reten√ß√£o e viraliza√ß√£o, seguindo a estrutura que voc√™ escolheu.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Para que servem os T√≠tulos Virais?</h3>
                        <p class="mt-2 text-gray-600">Para aumentar o CTR (taxa de cliques) dos seus v√≠deos. A IA gera duas op√ß√µes: "T√≠tulos Prontos", com an√°lise de pontua√ß√£o, ou "Estruturas de T√≠tulos", que s√£o modelos para voc√™ adaptar. √â ideal para combater o bloqueio criativo e encontrar a chamada perfeita para seu v√≠deo.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">O que s√£o os Prompts para Cenas?</h3>
                        <p class="mt-2 text-gray-600">Esta ferramenta transforma seu roteiro em comandos para IAs de gera√ß√£o de imagem (como Midjourney, Leonardo.AI). Voc√™ cola o roteiro e ela gera descri√ß√µes visuais para cada cena importante, prontas para serem usadas na cria√ß√£o das imagens do seu v√≠deo, economizando horas de trabalho.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">E os Prompts de Thumbnail?</h3>
                        <p class="mt-2 text-gray-600">Focado exclusivamente na capa do seu v√≠deo. Com base no t√≠tulo, a ferramenta gera prompts otimizados para criar thumbnails com alto potencial de clique, analisando o potencial de CTR e sugerindo melhorias.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Como o Conversor de SRT me ajuda?</h3>
                        <p class="mt-2 text-gray-600">Ele transforma um texto corrido (como a narra√ß√£o de um roteiro) em um arquivo de legendas no formato .SRT, com a temporiza√ß√£o calculada automaticamente. Essencial para acessibilidade e para alcan√ßar uma audi√™ncia maior.</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Qual a utilidade do Divisor de Texto?</h3>
                        <p class="mt-2 text-gray-600">√â uma ferramenta de produtividade para narradores. Ela analisa seu roteiro, mostra o tempo estimado de narra√ß√£o e o divide em blocos menores (por palavras ou caracteres), facilitando a grava√ß√£o do √°udio em partes, evitando erros e cansa√ßo.</p>
                    </div>
                </div>
            `
        }
    };
    
    let scriptResults = {
        fullResult: null,
        currentPage: 1,
        partsPerPage: 10
    };

    let scenePromptResults = {
        data: [],
        currentPage: 1,
        scenesPerPage: 10,
        allPromptsText: ''
    };
    
    let thumbnailPromptResults = {
        data: [],
        allPromptsText: ''
    };
    
    // --- Script History Management ---
    const saveScriptToHistory = (scriptData) => {
        const topic = document.getElementById('script-topic').value.trim() || 'Roteiro Sem T√≠tulo';
        let history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');
        const newEntry = {
            id: Date.now(),
            title: topic,
            date: new Date().toLocaleString('pt-BR'),
            data: scriptData
        };
        history.unshift(newEntry);
        if (history.length > 5) {
            history = history.slice(0, 5);
        }
        localStorage.setItem('scriptHistory', JSON.stringify(history));
    };

    const renderScriptHistory = () => {
        const container = document.getElementById('script-history-container');
        if (!container) return;
        const history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');

        if (history.length === 0) {
            container.innerHTML = '';
            return;
        }

        const historyItemsHtml = history.map(item => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                <div>
                    <p class="font-semibold text-gray-800">${item.title}</p>
                    <p class="text-xs text-gray-500">Salvo em: ${item.date}</p>
                </div>
                <button class="download-history-btn text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-3 rounded-lg" data-script-id="${item.id}">Baixar</button>
            </div>
        `).join('');

        container.innerHTML = `
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">Hist√≥rico de Roteiros</h3>
                    <button id="clear-history-btn" class="text-xs font-medium text-red-600 hover:underline">Limpar Hist√≥rico</button>
                </div>
                <div class="space-y-2">${historyItemsHtml}</div>
            </div>`;
    };

    function renderScriptPage() {
        const output = document.getElementById('output');
        const controlsContainer = document.getElementById('script-pagination-controls');
        
        output.innerHTML = '';
        if (controlsContainer) controlsContainer.innerHTML = '';

        const { fullResult, currentPage, partsPerPage } = scriptResults;
        const narrationOnly = document.getElementById('script-narration').checked;

        if (!fullResult || !fullResult.script_parts || fullResult.script_parts.length === 0) {
            output.innerHTML = '<div class="card p-4 text-center text-gray-500">Nenhum roteiro gerado.</div>';
            return;
        }

        const lang = document.getElementById('script-lang').value;
        const cardTitles = {
            'German': { retention: 'Retentionspotential', clarity: 'Klarheit der Botschaft', viral: 'Virales Potenzial', engagement: 'Engagement', comprehension: 'Verst√§ndnis', sharing: 'Teilen' },
            'default': { retention: 'Potencial de Reten√ß√£o', clarity: 'Clareza da Mensagem', viral: 'Potencial Viral', engagement: 'Engajamento', comprehension: 'Compreens√£o', sharing: 'Compartilhamento' }
        };
        const titles = cardTitles[lang] || cardTitles['default'];

        let scoreCardsHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">${renderScoreCard(titles.retention, fullResult.scores.retention_potential, { [titles.engagement]: fullResult.scores.retention_potential })}${renderScoreCard(titles.clarity, fullResult.scores.clarity_score, { [titles.comprehension]: fullResult.scores.clarity_score })}${renderScoreCard(titles.viral, fullResult.scores.viral_potential, { [titles.sharing]: fullResult.scores.viral_potential })}</div>`;
        let actionButtonsHtml = `<div class="card p-4 mb-4 flex flex-wrap gap-4">
            <button id="copy-script-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-blue-100 text-blue-800 hover:bg-blue-200">Copiar Roteiro</button>
            <button id="save-script-txt-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-100 text-green-800 hover:bg-green-200">Salvar em .txt</button>
            <button id="clear-script-output-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-800">Limpar Resultado</button>
        </div>`;
        
        let scriptHtml = '';

        if (narrationOnly) {
            scriptHtml = `
            <div class="card mb-4">
                <div class="p-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">Narra√ß√£o Completa (Pronta para Voice Over)</h3>
                    <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4">${fullResult.full_script_text.split('\n\n').map(p => `<p>${p}</p>`).join('')}</div>
                </div>
            </div>`;
            if (controlsContainer) controlsContainer.innerHTML = ''; 
        } else {
            const parts = fullResult.script_parts;
            const totalPages = Math.ceil(parts.length / partsPerPage);
            
            const startIndex = (currentPage - 1) * partsPerPage;
            const endIndex = startIndex + partsPerPage;
            const paginatedParts = parts.slice(startIndex, endIndex);

            scriptHtml = paginatedParts.map(part => `
                <div class="card mb-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg text-gray-800">${part.part_number}. ${part.part_title}</h3>
                            ${createCopyButton(part.part_content, 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}
                        </div>
                        <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4 mt-2">${part.part_content.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('')}</div>
                    </div>
                </div>`).join('');
            
            if (totalPages > 1 && controlsContainer) {
                let paginationHtml = '';
                paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Anterior</button>`;
                paginationHtml += `<span class="text-sm text-gray-600">P√°gina ${currentPage} de ${totalPages}</span>`;
                paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Pr√≥ximo</button>`;
                
                controlsContainer.innerHTML = paginationHtml;

                controlsContainer.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        scriptResults.currentPage = parseInt(e.currentTarget.dataset.page);
                        renderScriptPage();
                        output.scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }
        }
        
        output.innerHTML = scoreCardsHtml + actionButtonsHtml + scriptHtml;
    }

    function renderScenePage() {
        const output = document.getElementById('output');
        const controlsContainer = document.getElementById('scene-pagination-controls');
        output.innerHTML = '';
        if(controlsContainer) controlsContainer.innerHTML = '';

        const { data, currentPage, scenesPerPage } = scenePromptResults;

        if (!data || data.length === 0) {
            output.innerHTML = '<div class="card p-4 text-center text-gray-500">Nenhuma cena gerada.</div>';
            return;
        }

        const startIndex = (currentPage - 1) * scenesPerPage;
        const endIndex = startIndex + scenesPerPage;
        const paginatedItems = data.slice(startIndex, endIndex);

        scenePromptResults.allPromptsText = data.map((p, i) => `--- PROMPT CENA ${i+1} ---\n${p.prompt_text}`).join('\n\n');

        const scenesHtml = paginatedItems.map((item, index) => `
            <div class="prompt-card card p-4 border-l-4 border-gray-200 transition-colors">
                ${item.original_text ? `<blockquote class="border-l-4 border-gray-300 pl-4 py-2 mb-3 bg-gray-50 italic text-sm text-gray-600"><p>"${item.original_text}..."</p></blockquote>` : ''}
                <div class="flex justify-between items-start">
                     <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">Cena ${startIndex + index + 1}: ${item.scene_description}</h4>
                        <p class="font-mono text-sm text-gray-700 mt-2 bg-gray-100 p-2 rounded">${item.prompt_text}</p>
                     </div>
                     <button class="prompt-copy-btn ml-4 p-2 rounded-md bg-gray-200 hover:bg-gray-300" data-copy-text="${encodeURIComponent(item.prompt_text)}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                     </button>
                </div>
            </div>`).join('');
        
        const headerHtml = `
            <div class="card p-4 mb-4 flex flex-wrap gap-4">
                <button id="copy-all-scene-prompts" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-blue-100 text-blue-800 hover:bg-blue-200">Copiar Todos os ${data.length} Prompts</button>
                <button id="download-scene-prompts" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-100 text-green-800 hover:bg-green-200">Baixar Prompts (.txt)</button>
            </div>`;

        output.innerHTML = headerHtml + scenesHtml;

        const totalPages = Math.ceil(data.length / scenesPerPage);
        if (totalPages > 1 && controlsContainer) {
            let paginationHtml = '';
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Anterior</button>`;
            paginationHtml += `<span class="text-sm text-gray-600">P√°gina ${currentPage} de ${totalPages}</span>`;
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Pr√≥ximo</button>`;
            
            controlsContainer.innerHTML = paginationHtml;

            controlsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    scenePromptResults.currentPage = parseInt(e.currentTarget.dataset.page);
                    renderScenePage();
                    output.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }
    }

    const getPromptByLanguage = (lang, data, formulaKey) => {
        const { topic, niche, audience, tone, trendsLine, duration, parts, narrationStyle, ctaText, affiliateInstruction } = data;
        
        const formulas = {
             'universal_safe': 'F√ìRMULA PADR√ÉO "UNIVERSAL SAFE": 9 elementos universais que funcionam para qualquer nicho. Backup perfeito quando voc√™ n√£o sabe qual f√≥rmula usar. 80% de efic√°cia garantida para qualquer tipo de conte√∫do.',
            'faith_journey': 'FAITH JOURNEY - crescimento espiritual',
            'testimony_power': 'TESTIMONY POWER - testemunhos impactantes',
            'bible_wisdom': 'BIBLE WISDOM - estudos b√≠blicos',
            'gospel_share': 'GOSPEL SHARE - evangeliza√ß√£o',
            'praise_story': 'PRAISE STORY - hist√≥rias de f√©',
            'heart_break': 'HEART BREAK - narrativas emocionais intensas',
            'emotional_wave': 'EMOTIONAL WAVE - drama com build-up emocional',
            'life_change': 'LIFE CHANGE - transforma√ß√µes pessoais tocantes',
            'fear_factor': 'FEAR FACTOR - terror psicol√≥gico',
            'nightmare_mode': 'NIGHTMARE MODE - horror stories completas',
            'creepy_truth': 'CREEPY TRUTH - mist√©rios sombrios',
            'haunted_real': 'HAUNTED REAL - paranormal/sobrenatural',
            'ancient_wisdom': 'ANCIENT WISDOM - civiliza√ß√µes perdidas',
            'mystery_past': 'MYSTERY PAST - enigmas hist√≥ricos',
            'time_travel': 'TIME TRAVEL - jornadas hist√≥ricas imersivas',
            'civilization_rise': 'CIVILIZATION RISE - ascens√£o e queda de imp√©rios',
            'car_passion': 'CAR PASSION - paix√£o automotiva',
            'drive_test': 'DRIVE TEST - reviews detalhados',
            'speed_rush': 'SPEED RUSH - performance/racing',
            'auto_evolution': 'AUTO EVOLUTION - hist√≥ria automotiva',
            'garage_dreams': 'GARAGE DREAMS - cultura car',
            'space_wonder': 'SPACE WONDER - explora√ß√£o espacial',
            'planet_deep': 'PLANET DEEP - estudos planet√°rios',
            'cosmic_journey': 'COSMIC JOURNEY - viagens espaciais',
            'universe_scale': 'UNIVERSE SCALE - perspectiva c√≥smica',
            'alien_search': 'ALIEN SEARCH - vida extraterrestre',
            'teach_master': 'TEACH MASTER (Conceitos Complexos)\n\nTrigger emocional ‚Üí Explain simples ‚Üí Analogia poderosa ‚Üí Conectar experi√™ncia ‚Üí H√°bito pr√°tico',
            'skill_build': 'SKILL BUILD (Desenvolvimento de Habilidades)\n\nSitua√ß√£o atual ‚Üí Knowledge gap ‚Üí Instru√ß√£o passo-a-passo ‚Üí Learning check ‚Üí Level up',
            'concept_clarity': 'CONCEPT CLARITY (Explica√ß√µes Did√°ticas)\n\nCuriosidade ‚Üí Objeto de estudo ‚Üí Nova informa√ß√£o ‚Üí Compara√ß√£o ‚Üí Exemplo pr√°tico ‚Üí Pr√≥ximos passos ‚Üí Transforma√ß√£o',
            'profit_system': 'PROFIT SYSTEM (Estrat√©gias de Neg√≥cio)\n\nProblema real ‚Üí Research profundo ‚Üí Oportunidade identificada ‚Üí Framework pr√°tico ‚Üí Implementa√ß√£o ‚Üí Tracking resultados',
            'scale_smart': 'SCALE SMART (Crescimento)\n\nSitua√ß√£o atual ‚Üí Case study relevante ‚Üí An√°lise detalhada ‚Üí Li√ß√µes extra√≠das ‚Üí Execu√ß√£o pr√°tica',
            'mindset_money': 'MINDSET MONEY (Mentalidade Empresarial)\n\nMudan√ßa necess√°ria ‚Üí Insights profundos ‚Üí Nova mentalidade ‚Üí Desafios reais ‚Üí Sistemas ‚Üí Evolu√ß√£o ‚Üí Transforma√ß√£o',
            'convert_pro': 'CONVERT PRO (Persuas√£o/Vendas)\n\nCredibilidade estabelecida ‚Üí Oportunidade mostrada ‚Üí Necessidade criada ‚Üí Vantagem exclusiva ‚Üí Evid√™ncia social ‚Üí Riscos minimizados ‚Üí Timing perfeito',
            'viral_engine': 'VIRAL ENGINE (Content Marketing)\n\nValor genu√≠no ‚Üí Insight √∫nico ‚Üí Relev√¢ncia alta ‚Üí Aplicabilidade imediata ‚Üí Lembrete memor√°vel',
            'authority_build': 'AUTHORITY BUILD (Personal Branding)\n\nAutenticidade ‚Üí Unique value ‚Üí Trust building ‚Üí Helpfulness ‚Üí Opinion leadership ‚Üí Relationship ‚Üí Influence ‚Üí Transformation ‚Üí Your legacy',
            'transform_body': 'TRANSFORM BODY (Transforma√ß√£o F√≠sica)\n\nTruth atual ‚Üí Roadmap claro ‚Üí Assessment honesto ‚Üí Nutrition strategy ‚Üí System workout ‚Üí Form perfeita ‚Üí Optimize recovery ‚Üí Resultado ‚Üí Maintenance',
            'fit_fast': 'FIT FAST (Exerc√≠cios R√°pidos)\n\nForma demonstrada ‚Üí Intensidade progressiva ‚Üí Timing otimizado',
            'health_hack': 'HEALTH HACK (Sa√∫de/Wellness)\n\nH√°bitos atuais ‚Üí Evid√™ncia cient√≠fica ‚Üí A√ß√£o espec√≠fica ‚Üí Lifestyle integration ‚Üí Tracking progress ‚Üí Holistic approach',
            'epic_moment': 'EPIC MOMENT (Gaming Content)\n\nExpectativa criada ‚Üí Progress√£o mostrada ‚Üí Intensidade crescente ‚Üí Cl√≠max explosivo',
            'story_master_game': 'STORY MASTER (Narrativas)\n\nSetup envolvente ‚Üí Tens√£o constru√≠da ‚Üí Obst√°culo superado ‚Üí Resolu√ß√£o satisfat√≥ria ‚Üí Yokai (twist inesperado)',
            'react_value': 'REACT VALUE (Reaction Content)\n\nRelev√¢ncia estabelecida ‚Üí Experi√™ncia aut√™ntica ‚Üí An√°lise profunda ‚Üí Conex√£o pessoal ‚Üí Takeaway valioso',
            'cook_expert': 'COOK EXPERT (Receitas)\n\nCraving despertado ‚Üí Overview visual ‚Üí Organiza√ß√£o ingredientes ‚Üí Kitchen tips profissionais',
            'taste_journey': 'TASTE JOURNEY (Food Reviews)\n\nTease apetitoso ‚Üí Appearance atrativa ‚Üí Story interessante ‚Üí Taste experience ‚Üí Evaluation honesta',
            'home_transform': 'HOME TRANSFORM (Casa/Organiza√ß√£o)\n\nHumble in√≠cio ‚Üí Optimize espa√ßo ‚Üí Makeover completo ‚Üí Enjoy resultado',
            'create_magic': 'CREATE MAGIC (Processo Criativo)\n\nConceito inicial ‚Üí Refer√™ncias inspiradoras ‚Üí Esbo√ßo planejado ‚Üí Aplica√ß√£o t√©cnica ‚Üí T√©cnicas avan√ßadas ‚Üí Execu√ß√£o final',
            'inspire_deep': 'INSPIRE DEEP (Arte/Design)\n\nInsight inicial ‚Üí Necessidade identificada ‚Üí Solu√ß√£o criativa ‚Üí Processo detalhado ‚Üí Insights aprofundados ‚Üí Revela√ß√£o final ‚Üí Evolu√ß√£o cont√≠nua',
            'discovery_method': 'DISCOVERY METHOD (Pesquisa/Ci√™ncia)\n\nD√∫vida intrigante ‚Üí Investiga√ß√£o rigorosa ‚Üí Surpresa reveladora ‚Üí Compreens√£o profunda ‚Üí Oportunidade futura ‚Üí Verifica√ß√£o ‚Üí Evolu√ß√£o ‚Üí Reflex√£o ‚Üí Yearning more',
            'tech_review': 'TECH REVIEW (Tecnologia)\n\nTend√™ncia atual ‚Üí Especifica√ß√µes t√©cnicas ‚Üí Compara√ß√£o detalhada ‚Üí Hands-on real',
            'future_vision': 'FUTURE VISION (Inova√ß√£o)\n\nFato presente ‚Üí Understanding problema ‚Üí Technology solution ‚Üí Upgrade implications ‚Üí Roadmap timeline ‚Üí Execution strategy',
            'mystery_solver': 'MYSTERY SOLVER (True Crime)\n\nMist√©rio apresentado ‚Üí Yielding clues ‚Üí Series de eventos ‚Üí Twist revelador ‚Üí Evid√™ncias ‚Üí Resolu√ß√£o ‚Üí Yokai final',
            'reveal_process': 'REVEAL PROCESS (Investiga√ß√£o)\n\nRitual inicial ‚Üí Evid√™ncias coletadas ‚Üí V√°rios √¢ngulos ‚Üí Expert analysis ‚Üí Assessment ‚Üí Links conectados',
            'mindset_shift': 'MINDSET SHIFT (Mudan√ßa Mental)\n\nMirror atual ‚Üí Insights reveladores ‚Üí Nova perspectiva ‚Üí Desafio aceito ‚Üí Sistemas criados ‚Üí Evolu√ß√£o ‚Üí Tracking progress',
            'breakthrough_now': 'BREAKTHROUGH NOW (Supera√ß√£o)\n\nBlockage identificado ‚Üí Revela√ß√£o poderosa ‚Üí Entendimento profundo ‚Üí Aplica√ß√£o pr√°tica ‚Üí Key habits ‚Üí Tracking ‚Üí Habits ‚Üí Resultado ‚Üí Oportunidade ‚Üí Upgrade ‚Üí Growth ‚Üí Habits consolidados',
            'habit_master': 'HABIT MASTER (Forma√ß√£o de H√°bitos)\n\nH√°bito atual ‚Üí An√°lise comportamental ‚Üí Binding new habit ‚Üí Implementa√ß√£o ‚Üí Tracking progress',
            'travel_deep': 'TRAVEL DEEP (Viagens)\n\nTransport/chegada ‚Üí Realidade local ‚Üí Aventura vivida ‚Üí Vis√£o cultural ‚Üí Experi√™ncia √∫nica ‚Üí Li√ß√µes aprendidas',
            'culture_immersion': 'CULTURE IMMERSION (Explora√ß√£o Cultural)\n\nContexto hist√≥rico ‚Üí Uni√£o com locals ‚Üí Li√ß√µes tradicionais ‚Üí Tradi√ß√µes vividas ‚Üí Understanding profundo ‚Üí Reflex√£o ‚Üí Evolu√ß√£o pessoal',
            'wealth_build': 'WEALTH BUILD (Constru√ß√£o de Riqueza)\n\nWhere you are ‚Üí Earnings analysis ‚Üí Assets leverage ‚Üí Long-term strategy ‚Üí Tracking ‚Üí Habits million√°rios',
            'invest_smart': 'INVEST SMART (Investimentos)\n\nInsights mercado ‚Üí Numbers an√°lise ‚Üí Vantagem identificada ‚Üí Estrat√©gia definida ‚Üí Simulation ‚Üí Timing execu√ß√£o',
            'money_mastery': 'MONEY MASTERY (Educa√ß√£o Financeira)\n\nMoney blocks ‚Üí Oportunidades ‚Üí Necessidades reais ‚Üí Estrat√©gias pr√°ticas ‚Üí Yokai mindset',
            'viral_education': 'VIRAL EDUCATION (Edutainment)\n\nViral hook ‚Üí Insight valioso ‚Üí Revela√ß√£o surpreendente ‚Üí Aplica√ß√£o pr√°tica ‚Üí Li√ß√µes duradouras',
            'story_teach': 'STORY TEACH (Narrativa Educativa)\n\nSetup emocional ‚Üí Tens√£o educativa ‚Üí Obst√°culos superados ‚Üí Revela√ß√£o insight ‚Üí Yokai transformation',
            'comparison_master': 'COMPARISON MASTER (Reviews/Compara√ß√µes)\n\nContexto estabelecido ‚Üí Op√ß√µes apresentadas ‚Üí Metodologia clara ‚Üí Pros/contras ‚Üí An√°lise profunda ‚Üí Recomenda√ß√£o ‚Üí Insights ‚Üí Summary ‚Üí Outcome ‚Üí Next steps'
        };

        const selectedFormula = formulas[formulaKey] || 'Nenhuma f√≥rmula selecionada. Crie um roteiro padr√£o de alta reten√ß√£o.';

        const templates = {
            'default': {
                main: `Voc√™ √© o DARKSCRIPT, um roteirista de elite para o YouTube com um estilo de escrita humano, direto e envolvente. Sua miss√£o √© gerar um roteiro completo e detalhado seguindo as especifica√ß√µes e a f√≥rmula de copywriting.`,
                style_guide: `**GUIA DE ESTILO E TOM (OBRIGAT√ìRIO):**
- **Seja Humano e Conversacional:** Escreva como se estivesse conversando com um amigo. Use uma linguagem natural, direta e evite jarg√µes corporativos ou acad√™micos.
- **Evite Clich√™s:** N√ÉO use frases como "embarque nessa jornada", "prepare-se para mergulhar", "no v√≠deo de hoje", "vamos explorar", "e muito mais". Seja criativo e original.
- **Evite Repeti√ß√µes:** Varie o vocabul√°rio e a estrutura das frases. N√£o comece par√°grafos seguidos da mesma maneira.
- **In√≠cio Impactante (Regra Especial):** Se a f√≥rmula selecionada for "UNIVERSAL SAFE", NUNCA comece o roteiro com "Bem-vindo" ou sauda√ß√µes. Comece diretamente com uma frase forte, uma pergunta ou um fato que capture a aten√ß√£o imediatamente relacionado ao tema.`,
                formula_section: `**F√ìRMULA DE ESTRUTURA (OBRIGAT√ìRIA):**\nSiga ESTRITAMENTE a seguinte f√≥rmula de copywriting para estruturar o roteiro:\n\n${selectedFormula}\n\nAplique cada etapa da f√≥rmula de forma clara e deliberada ao longo das ${parts} partes do roteiro.`,
                specs: `**ESPECIFICA√á√ïES DO ROTEIRO:**`,
                topic: `- TEMA CENTRAL: ${topic}`,
                niche: `- NICHO: ${niche}`,
                audience: `- P√öBLICO: ${audience}`,
                tone: `- TOM NARRATIVO: ${tone}`,
                lang: `- IDIOMA: ${lang}`,
                trends: `- TERMO EM ALTA: ${trendsLine}`,
                duration: `- DURA√á√ÉO ESTIMADA: ${duration} minutos`,
                rules: `**REGRAS ABSOLUTAS E INQUEBR√ÅVEIS:**`,
                rule1: `1.  **REGRA DE COMPLETUDE (PRIORIDADE M√ÅXIMA):** Voc√™ DEVE gerar o conte√∫do completo para TODAS as ${parts} partes solicitadas. √â proibido parar no meio.`,
                rule2: `2.  **REGRA DE DENSIDADE DE CONTE√öDO (PRIORIDADE M√ÅXIMA):** Cada parte individual DEVE ter aproximadamente **2500 CARACTERES** (cerca de 400 palavras). Roteiros com partes curtas (menos de 2000 caracteres) s√£o considerados falhas. Seja profundo, detalhado e explore o t√≥pico para atingir essa meta em CADA parte.`,
                rule3: `3.  **REGRA DE ESTRUTURA DE PAR√ÅGRAFOS:** O conte√∫do denso de cada parte (~2500 caracteres) DEVE ser dividido em exatamente **5 par√°grafos** coesos e bem escritos.`,
                rule4: `4.  **REGRA DE N√öMERO DE PARTES:** O roteiro final DEVE conter exatamente ${parts} partes. Nem mais, nem menos.`,
                rule5: `5.  **NARRA√á√ÉO E CTAS:**`,
                narration: `- Estilo: ${narrationStyle}`,
                cta: `- CTAs: Inclua chamadas para a√ß√£o organicamente nas seguintes se√ß√µes: ${ctaText}.`,
                affiliate: affiliateInstruction,
                output: `**INSTRU√á√ïES DE SA√çDA (FORMATO DE TEXTO ESTRUTURADO OBRIGAT√ìRIO):**`,
                score_instruction: `- Ao avaliar o roteiro, garanta que a pontua√ß√£o 'viral_potential' seja alta (preferencialmente acima de 80) para refletir o uso de uma estrutura de copywriting de alta performance.`,
                output1: `- Na PRIMEIRA linha, e SOMENTE na primeira linha, coloque as pontua√ß√µes no seguinte formato JSON:\nSCORES:{"retention_potential": <score>, "clarity_score": <score>, "viral_potential": <score>}`,
                output2: `- A partir da segunda linha, inicie o roteiro.`,
                output3: `- Use o seguinte marcador para separar CADA parte do roteiro:\n[--PART <n√∫mero>: <t√≠tulo da parte>--]\n<conte√∫do da parte com 5 par√°grafos e ~2500 caracteres>\n[--ENDPART--]`
            }
        };

        const t = templates[lang] || templates['default'];
        
        return [
            t.main, t.style_guide, t.formula_section, t.specs, t.topic, t.niche, t.audience, t.tone, t.lang,
            (trendsLine ? t.trends : ''), t.duration, t.rules, t.rule1, t.rule2, t.rule3, t.rule4, t.rule5,
            t.narration, t.cta, t.affiliate, t.output, t.score_instruction, t.output1, t.output2, t.output3
        ].filter(Boolean).join('\n\n');
    }


    const handlers = {
        'generate-script': async (output) => {
            const niche = document.getElementById('script-niche').value.trim();
            const audience = document.getElementById('script-audience').value.trim();
            const topic = document.getElementById('script-topic').value.trim();
            const trendsTerm = document.getElementById('script-trends-term').value.trim();
            const duration = document.getElementById('script-duration').value;
            const narrationOnly = document.getElementById('script-narration').checked;
            const includeAffiliate = document.getElementById('include-affiliate-product').checked;
            const affiliateProduct = document.getElementById('affiliate-product-description').value.trim();
            const tone = document.getElementById('script-tone').value;
            const lang = document.getElementById('script-lang').value;
            const formula = document.getElementById('script-formula').value;
            const ctaPositions = Array.from(document.querySelectorAll('[id^="cta-"]:checked')).map(cb => cb.id.replace('cta-', ''));

            if (!topic || !duration || !niche || !audience) {
                alert("Por favor, preencha todos os campos obrigat√≥rios.");
                return;
            }
            if (!formula) {
                alert("Por favor, selecione uma F√≥rmula de Estrutura.");
                return;
            }
            
            if (includeAffiliate && !affiliateProduct) {
                alert("Por favor, descreva o produto de afilia√ß√£o que deseja incluir.");
                return;
            }

            const parts = document.getElementById('script-parts').value;
            
            const promptData = {
                topic, niche, audience, tone, lang, duration, parts,
                trendsLine: trendsTerm,
                narrationStyle: narrationOnly ? "100% narra√ß√£o pura para voice-over." : "Narra√ß√£o com descri√ß√µes visuais concisas.",
                ctaText: ctaPositions.length > 0 ? ctaPositions.join(', ') : 'meio',
                affiliateInstruction: includeAffiliate ? `INSTRU√á√ÉO ADICIONAL (ALTA PRIORIDADE): - Integre de forma NATURAL e PERSUASIVA uma men√ß√£o ao seguinte produto de afilia√ß√£o no roteiro: "${affiliateProduct}".` : ''
            };
            
            const prompt = getPromptByLanguage(lang, promptData, formula);

            const resultText = (await callAIModel(prompt, null)).text;

            try {
                const lines = resultText.split('\n');
                const scoresLine = lines.find(line => line.startsWith('SCORES:'));
                const scores = scoresLine ? JSON.parse(scoresLine.replace('SCORES:', '').trim()) : { retention_potential: 75, clarity_score: 75, viral_potential: 75 };
                
                const scriptContent = lines.slice(scoresLine ? 1 : 0).join('\n');
                const partsRaw = scriptContent.split('[--ENDPART--]').filter(p => p.trim());
                
                const script_parts = partsRaw.map((partRaw, index) => {
                    const match = partRaw.match(/\[--PART (\d+): (.*?)--\]/);
                    const part_number = match ? parseInt(match[1], 10) : index + 1;
                    const part_title = match ? match[2].trim() : `Parte ${index + 1}`;
                    const part_content = partRaw.replace(/\[--PART \d+: .*?--\]/, '').trim();
                    return { part_number, part_title, part_content };
                });

                if (script_parts.length === 0) throw new Error("A IA n√£o retornou um roteiro v√°lido.");

                const full_script_text = script_parts.map(part => part.part_content).join('\n\n');

                const finalResult = { scores, script_parts, full_script_text };

                scriptResults.fullResult = finalResult;
                scriptResults.currentPage = 1;

                saveScriptToHistory(finalResult);
                renderScriptHistory();
                document.getElementById('legend-container').innerHTML = getLegendForTool('script-writer');
                renderScriptPage();
                showSuccessToast("Roteiro gerado com sucesso!");

            } catch (error) {
                console.error("Erro ao processar a resposta da IA:", error);
                addToLog("A resposta da IA n√£o veio no formato esperado. Tente novamente.", true);
            }
        },
        'generate-viral-content': async (output, append = false) => {
            const topic = document.getElementById('viral-topic').value.trim();
            const type = document.getElementById('viral-type').value;
            const lang = document.getElementById('viral-lang').value;
            
            if (!topic) { 
                alert("Por favor, insira um tema."); 
                return; 
            }

            let prompt, schema, renderer;

            if (type === 'titles') {
                prompt = `Aja como um copywriter de YouTube de elite. Crie 4 t√≠tulos virais e in√©ditos em "${lang}" sobre "${topic}". REGRAS: 1. **Combine de 2 a 4 modelos de t√≠tulos diferentes** (ex: "Lista" + "Aviso" + "Como Fazer") para criar cada t√≠tulo. 2. O t√≠tulo final N√ÉO PODE exceder 100 caracteres. 3. Responda APENAS com o JSON. Para cada t√≠tulo, forne√ßa: 'title', 'category' (os modelos combinados), 'suggestion' (1 frase em portugu√™s explicando a psicologia), e 'scores' (um objeto com 'impacto', 'clareza', 'curiosidade' de 0 a 100).`;
                schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            title: { type: "STRING" },
                            category: { type: "STRING" },
                            suggestion: { type: "STRING" },
                            scores: {
                                type: "OBJECT",
                                properties: {
                                    impacto: { type: "NUMBER" },
                                    clareza: { type: "NUMBER" },
                                    curiosidade: { type: "NUMBER" }
                                },
                                required: ["impacto", "clareza", "curiosidade"]
                            }
                        },
                        required: ["title", "category", "suggestion", "scores"]
                    }
                };
                renderer = (result) => result.map(item => {
                    const scores = item.scores || { impacto: 60, clareza: 60, curiosidade: 60 };
                    const mainScore = (scores.impacto + scores.clareza + scores.curiosidade) / 3;
                    return `
                    <div class="card p-4 flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">${item.title || 'T√≠tulo Indispon√≠vel'}</h3>
                                ${createCopyButton(item.title || '', 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${item.category || 'Categoria'}</span>
                            </div>
                        </div>
                        <div class="w-full md:w-56 flex-shrink-0 border-t md:border-t-0 md:border-l pt-4 md:pt-0 md:pl-4 mt-4 md:mt-0">
                            ${renderScoreCard('Potencial de Cliques', mainScore, scores, item.suggestion || 'Sem sugest√£o.')}
                        </div>
                    </div>`;
                }).join('');
            } else { // structures
                prompt = `Aja como um copywriter de YouTube de elite. Crie 4 ESTRUTURAS de t√≠tulo in√©ditas e criativas em "${lang}" para v√≠deos sobre "${topic}". REGRAS: 1. **Combine de 2 a 4 modelos de t√≠tulos diferentes** para criar cada estrutura. 2. A estrutura final N√ÉO PODE exceder 100 caracteres. 3. Use placeholders como [DOR], [N√öMERO], [BENEF√çCIO]. 4. Responda APENAS com o JSON. Para cada estrutura, forne√ßa: 'structure' (o modelo), 'category' (os modelos combinados), e 'explanation' (1 frase em portugu√™s de como usar).`;
                schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            structure: { type: "STRING" },
                            category: { type: "STRING" },
                            explanation: { type: "STRING" },
                        },
                        required: ["structure", "category", "explanation"]
                    }
                };
                renderer = (result) => result.map(item => `
                    <div class="card p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-lg flex-1">${item.structure || 'Estrutura Indispon√≠vel'}</h3>
                            ${createCopyButton(item.structure || '', 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}
                        </div>
                         <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">${item.category || 'Categoria'}</span>
                        </div>
                        <p class="text-sm text-gray-600">${item.explanation || 'Sem explica√ß√£o.'}</p>
                    </div>
                `).join('');
            }

            const result = await callAIModel(prompt, schema);
            
            if (!result || !Array.isArray(result) || result.length === 0) {
                addToLog("A resposta da IA n√£o est√° no formato esperado ou est√° vazia.", true);
                output.innerHTML = '<p class="text-center text-red-600">Ocorreu um erro ao gerar o conte√∫do. Por favor, tente novamente com um tema diferente.</p>';
                return;
            }

            let html = renderer(result);
            
            if (append) {
                output.insertAdjacentHTML('beforeend', html);
            } else {
                document.getElementById('legend-container').innerHTML = getLegendForTool('viral-titles');
                output.innerHTML = html;
            }
            document.getElementById('generate-more-viral-content').style.display = 'block';
            showSuccessToast("Conte√∫do gerado!");
        },
        'generate-scene-prompts': async(output) => {
            const text = document.getElementById('scene-text').value.trim();
            const platform = document.getElementById('scene-platform').value;
            const mode = document.getElementById('generation-mode').value;
            const wordCount = document.getElementById('scene-word-count').value;

            if (!text) { alert("Por favor, cole um roteiro."); return; }
            
            const platformConfigs = {
                'Midjourney': 'Foque em composi√ß√£o cinematogr√°fica, use par√¢metros como --ar 16:9, --style raw, e descreva a ilumina√ß√£o (ex: volumetric lighting, cinematic lighting). Crie prompts concisos e diretos.',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k, masterpiece". Descreva a emo√ß√£o, a paleta de cores e o estilo art√≠stico (ex: "in the style of Greg Rutkowski").',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de um detetive em um escrit√≥rio escuro, iluminado apenas pela luz de uma janela com persianas, fuma√ßa de cigarro no ar, em um estilo noir cl√°ssico."',
                'Wisk': 'Prompts devem ser claros, focados em objetos e a√ß√µes. Use termos como "Fotografia de...", "Ilustra√ß√£o vetorial de...".',
                'Nano Banana': 'Ideal para estilos mais art√≠sticos e surreais. Use linguagem po√©tica e descri√ß√µes abstratas. Ex: "um rel√≥gio derretendo sobre uma paisagem des√©rtica, com nuvens em formato de borboletas".',
                'Flux': 'Focado em alta qualidade e realismo. Use descri√ß√µes detalhadas de texturas, materiais e ilumina√ß√£o. "Close-up extremo de uma gota de chuva em uma p√©tala de rosa vermelha, com reflexos macro, ultra-realista".',
                'Freepik': 'Use termos comerciais e diretos, focados em conceitos. "Homem de neg√≥cios sorrindo e apertando a m√£o de um rob√¥ em um escrit√≥rio moderno, simbolizando parceria entre humano e IA, fundo branco, estilo de foto de banco de imagem."'
            };

            let chunks = [];
            const words = text.split(/\s+/).filter(Boolean);

            if (mode === 'manual') {
                 const step = parseInt(wordCount, 10);
                 for (let i = 0; i < words.length; i += step) {
                    chunks.push(words.slice(i, i + step).join(' '));
                }
            } else { // modo autom√°tico
                chunks = [text];
            }

            let prompt;
            if (mode === 'auto') {
                 prompt = `Como um diretor de arte, analise o roteiro a seguir e gere prompts de imagem em INGL√äS otimizados para a IA '${platform}'. Siga esta diretriz de estilo: "${platformConfigs[platform]}". Identifique os momentos-chave e crie 2 prompts cinematogr√°ficos para cada cena importante. Para cada prompt, retorne tamb√©m o trecho EXATO do roteiro original que o inspirou no campo 'original_text'.\n\nROTEIRO:\n${chunks[0]}`;
            } else {
                 const formattedChunks = chunks.map((chunk, index) => `TRECHO ${index + 1}:\n"""${chunk}"""`).join('\n\n');
                 prompt = `Como um diretor de arte, sua tarefa √© processar os seguintes trechos de um roteiro. Para CADA trecho fornecido (delimitado por """ e identificado como TRECHO N), gere EXATAMENTE 1 prompt de imagem cinematogr√°fico em INGL√äS otimizado para a IA '${platform}'. Siga esta diretriz de estilo: "${platformConfigs[platform]}". O n√∫mero de prompts gerados deve ser id√™ntico ao n√∫mero de trechos de texto (${chunks.length}). N√£o combine nem omita nenhum trecho. Para cada prompt, retorne tamb√©m o trecho EXATO do roteiro original que o inspirou no campo 'original_text'.\n\nTRECHOS DO ROTEIRO:\n${formattedChunks}`;
            }

            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { scene_description: {type: "STRING"}, prompt_text: { type: "STRING" }, original_text: {type: "STRING"}} } };
            const result = await callAIModel(prompt, schema);
            
            scenePromptResults.data = result;
            scenePromptResults.currentPage = 1;
            
            renderScenePage();
            showSuccessToast("Prompts de cena gerados!");
        },
        'generate-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { alert("Por favor, insira um t√≠tulo."); return; }

            const platformConfigs = {
                'Midjourney': 'Foque em composi√ß√£o cinematogr√°fica, use par√¢metros como --ar 16:9, --style raw, e descreva a ilumina√ß√£o (ex: volumetric lighting, cinematic lighting). Crie prompts concisos e diretos.',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k, masterpiece". Descreva a emo√ß√£o, a paleta de cores e o estilo art√≠stico (ex: "in the style of Greg Rutkowski").',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de um detetive em um escrit√≥rio escuro, iluminado apenas pela luz de uma janela com persianas, fuma√ßa de cigarro no ar, em um estilo noir cl√°ssico."',
                'Wisk': 'Prompts devem ser claros, focados em objetos e a√ß√µes. Use termos como "Fotografia de...", "Ilustra√ß√£o vetorial de...".',
                'Nano Banana': 'Ideal para estilos mais art√≠sticos e surreais. Use linguagem po√©tica e descri√ß√µes abstratas. Ex: "um rel√≥gio derretendo sobre uma paisagem des√©rtica, com nuvens em formato de borboletas".',
                'Flux': 'Focado em alta qualidade e realismo. Use descri√ß√µes detalhadas de texturas, materiais e ilumina√ß√£o. "Close-up extremo de uma gota de chuva em uma p√©tala de rosa vermelha, com reflexos macro, ultra-realista".',
                'Freepik': 'Use termos comerciais e diretos, focados em conceitos. "Homem de neg√≥cios sorrindo e apertando a m√£o de um rob√¥ em um escrit√≥rio moderno, simbolizando parceria entre humano e IA, fundo branco, estilo de foto de banco de imagem."'
            };

            const prompt = `Gere 2 prompts AVAN√áADOS em INGL√äS para a IA '${platform}' para uma thumbnail sobre "${title}". Siga esta diretriz de estilo para otimizar o prompt: "${platformConfigs[platform]}". Para cada prompt, forne√ßa:
            1.  'score': uma pontua√ß√£o de potencial de CTR (0-100).
            2.  'suggestion': uma "virada de chave" (melhoria principal) em PORTUG√äS, BEM CURTA, com no m√°ximo 5 linhas.`;
            
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } };
            
            const result = await callAIModel(prompt, schema);
            
            if (append) {
                thumbnailPromptResults.data.push(...result);
            } else {
                thumbnailPromptResults.data = result;
            }

            thumbnailPromptResults.allPromptsText = thumbnailPromptResults.data.map((p, i) => `--- PROMPT THUMBNAIL ${i+1} ---\n${p.prompt}`).join('\n\n');

            let html = result.map(item => `<div class="card p-4 flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-start"><p class="font-mono text-sm bg-gray-100 p-2 rounded flex-1">${item.prompt}</p>${createCopyButton(item.prompt, 'ml-2 p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}</div></div><div class="w-full md:w-56 flex-shrink-0">${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score, 'Clareza': item.score > 10 ? item.score - 5 : item.score }, item.suggestion)}</div></div>`).join('');
            
            if (append) {
                document.getElementById('output').insertAdjacentHTML('beforeend', html);
            } else {
                document.getElementById('legend-container').innerHTML = getLegendForTool('thumbnail-prompts');
                output.innerHTML = html;
            }
            
            document.getElementById('thumb-actions').innerHTML = `
                <button id="download-thumb-prompts" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-green-100 text-green-800 hover:bg-green-200">
                    Baixar ${thumbnailPromptResults.data.length} Prompts (.txt)
                </button>`;
            document.getElementById('generate-more-prompts').style.display = 'block';
            if(!append) showSuccessToast("Prompts de thumbnail gerados!");

        },
        'convert-to-srt': (output) => {
            const text = document.getElementById('srt-input-text').value;
            const charLimit = parseInt(document.getElementById('srt-char-limit').value, 10);

            if (!text.trim() || isNaN(charLimit) || charLimit <= 0) {
                alert("Por favor, cole um texto e defina um limite de caracteres v√°lido.");
                return;
            }

            const chunks = [];
            let currentIndex = 0;
            const textLength = text.length;

            while (currentIndex < textLength) {
                let endIndex = currentIndex + charLimit;
                if (endIndex >= textLength) {
                    chunks.push(text.substring(currentIndex).trim());
                    break;
                }

                let potentialCutOff = text.substring(currentIndex, endIndex);
                let splitIndex = -1;

                const sentenceEndChars = /[.?!]/g;
                let lastMatch;
                while ((lastMatch = sentenceEndChars.exec(potentialCutOff)) !== null) {
                    splitIndex = lastMatch.index + 1;
                }

                if (splitIndex === -1) {
                    const lastSpace = potentialCutOff.lastIndexOf(' ');
                    if (lastSpace !== -1) {
                        splitIndex = lastSpace;
                    } else {
                        splitIndex = charLimit;
                    }
                }
                
                let chunk = text.substring(currentIndex, currentIndex + splitIndex).trim();
                if (chunk) {
                    chunks.push(chunk);
                }
                currentIndex += splitIndex;
            }

            let srtContent = "";
            let startTime = 0; // in seconds
            chunks.forEach((chunk, index) => {
                const wordsPerSecond = 3;
                const wordCount = chunk.split(/\s+/).filter(Boolean).length;
                const duration = Math.max(2, Math.ceil(wordCount / wordsPerSecond)); 

                const formatTime = (seconds) => {
                    return new Date(seconds * 1000).toISOString().substr(11, 12).replace('.', ',');
                };

                const start = formatTime(startTime);
                const end = formatTime(startTime + duration);
                
                srtContent += `${index + 1}\n${start} --> ${end}\n${chunk}\n\n`;
                
                startTime += duration + 10;
            });
            
             output.innerHTML = `<div class="card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold">Resultado SRT</h4>
                        <div class="flex gap-2">
                            <button id="download-srt-btn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Download</button>
                            <button id="clear-srt-btn" class="text-xs bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Limpar</button>
                        </div>
                    </div>
                    <pre id="srt-result-content" class="whitespace-pre-wrap text-sm bg-gray-50 p-2 rounded border max-h-72 overflow-y-auto">${srtContent.trim()}</pre>
                </div>`;
            
            document.getElementById('download-srt-btn').addEventListener('click', () => {
                const srtFinalContent = document.getElementById('srt-result-content').textContent;
                downloadFile(srtFinalContent, 'legendas.srt');
            });

            document.getElementById('clear-srt-btn').addEventListener('click', () => {
                document.getElementById('srt-input-text').value = '';
                output.innerHTML = '';
            });
             showSuccessToast("Arquivo .SRT convertido!");
        },
        'split-text-btn': () => {
            const text = document.getElementById('text-divider-input').value.trim();
            const chunkSize = parseInt(document.getElementById('split-chunk-size').value, 10);
            const chunkType = document.getElementById('split-chunk-type').value;
            const outputEl = document.getElementById('output');
            if (!text || isNaN(chunkSize) || chunkSize <= 0) return;

            const parts = [];
            if (chunkType === 'word') {
                const words = text.split(/\s+/).filter(Boolean);
                for (let i = 0; i < words.length; i += chunkSize) {
                    parts.push(words.slice(i, i + chunkSize).join(' '));
                }
            } else { // by character
                for (let i = 0; i < text.length; i += chunkSize) {
                    parts.push(text.substring(i, i + chunkSize));
                }
            }
            outputEl.innerHTML = parts.map((part, index) => `<div class="card p-4 relative"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Parte ${index + 1}</h4>${createCopyButton(part, 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}</div><p class="text-gray-700 bg-gray-50 p-2 rounded border">${part}</p></div>`).join('');
            showSuccessToast("Texto dividido com sucesso!");
        }
    };
    
    // --- Main Render Function ---
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        document.getElementById('tab-content').innerHTML = `<div class="fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-1">${tool.title}</h2><p class="text-gray-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        document.getElementById('mobile-header-title').textContent = tool.title;
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menu-overlay').style.display = 'none';

        if (tabId === 'settings') initializeSettings();
        if (tabId === 'admin') initializeAdminPanel();
        if (tabId === 'text-divider') initializeTextDivider();
        if (tabId === 'script-writer') {
            document.getElementById('script-duration').addEventListener('input', e => {
                const duration = parseInt(e.target.value, 10);
                const partsInput = document.getElementById('script-parts');
                if (duration > 0) {
                    partsInput.value = Math.ceil(duration / 2.5);
                } else {
                    partsInput.value = '';
                }
            });
            document.getElementById('include-affiliate-product').addEventListener('change', (e) => {
                document.getElementById('affiliate-product-container').style.display = e.target.checked ? 'block' : 'none';
            });
            renderScriptHistory(); 
        }
        if (tabId === 'scene-prompts'){
           initializeScenePrompts();
        }
        if (tabId === 'viral-titles') {
            const viralTypeSelect = document.getElementById('viral-type');
            if (viralTypeSelect) {
                viralTypeSelect.addEventListener('change', () => {
                    document.getElementById('output').innerHTML = '';
                    document.getElementById('generate-more-viral-content').style.display = 'none';
                });
            }
        }
        
        thumbnailPromptResults.data = []; 
        thumbnailPromptResults.allPromptsText = '';

        const outputEl = document.getElementById('output');
        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', (e) => handlers[buttonId](outputEl, e));
            }
        });
        
        const morePromptsBtn = document.getElementById('generate-more-prompts');
        if(morePromptsBtn){
            morePromptsBtn.addEventListener('click', () => handlers['generate-prompts'](outputEl, true));
        }
        
        const moreViralContentBtn = document.getElementById('generate-more-viral-content');
        if(moreViralContentBtn){
            moreViralContentBtn.addEventListener('click', () => handlers['generate-viral-content'](outputEl, true));
        }
    }

    // --- Specific Initializers ---
    function initializeScenePrompts() {
        const textInput = document.getElementById('scene-text');
        const wordCounter = document.getElementById('scene-word-counter');
        const modeSelector = document.getElementById('generation-mode');
        const manualOptions = document.getElementById('manual-options');
        const wordCountInput = document.getElementById('scene-word-count');
        const scenePreview = document.getElementById('scene-preview');

        const countWords = (text) => text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        
        const updatePreview = () => {
            const totalWords = countWords(textInput.value);
            const wordsPerScene = parseInt(wordCountInput.value, 10);
            if(totalWords > 0 && wordsPerScene > 0) {
                const sceneCount = Math.ceil(totalWords / wordsPerScene);
                scenePreview.textContent = `~ ${sceneCount} cenas ser√£o geradas.`;
            } else {
                scenePreview.textContent = '';
            }
        };

        textInput.addEventListener('input', () => {
            const totalWords = countWords(textInput.value);
            wordCounter.textContent = `${totalWords} palavras`;
            if (modeSelector.value === 'manual') {
                updatePreview();
            }
        });
        
        modeSelector.addEventListener('change', e => {
            const isManual = e.target.value === 'manual';
            manualOptions.style.display = isManual ? 'flex' : 'none';
            if(isManual) updatePreview(); else scenePreview.textContent = '';
        });

        wordCountInput.addEventListener('input', updatePreview);
    }

    function initializeSettings() {
        const openAIKeyInput = document.getElementById('openai-key');
        const geminiKeyInput1 = document.getElementById('gemini-key-1');
        const geminiKeyInput2 = document.getElementById('gemini-key-2');
        const geminiKeyInput3 = document.getElementById('gemini-key-3');
        const feedbackEl = document.getElementById('settings-feedback');

        apiRequest('/api/settings', 'GET').then(savedSettings => {
             openAIKeyInput.value = savedSettings.openai || '';
             if(Array.isArray(savedSettings.gemini)) {
                 geminiKeyInput1.value = savedSettings.gemini[0] || '';
                 geminiKeyInput2.value = savedSettings.gemini[1] || '';
                 geminiKeyInput3.value = savedSettings.gemini[2] || '';
             } else {
                 geminiKeyInput1.value = savedSettings.gemini || '';
             }
        });

        document.getElementById('save-settings').addEventListener('click', async () => {
            const settingsToSave = {
                openai: openAIKeyInput.value.trim(),
                gemini: [
                    geminiKeyInput1.value.trim(),
                    geminiKeyInput2.value.trim(),
                    geminiKeyInput3.value.trim()
                ]
            };
            try {
                await apiRequest('/api/settings', 'POST', { settings: settingsToSave });
                showSuccessToast('Configura√ß√µes salvas!');
            } catch(e) {
                feedbackEl.textContent = 'Erro ao salvar no servidor.';
                feedbackEl.className = 'text-red-600';
                 setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        });
    }
    
    function initializeTextDivider() {
        const textInput = document.getElementById('text-divider-input');
        const wordCountEl = document.getElementById('word-count');
        const charCountEl = document.getElementById('char-count');
        const timeEstimateEl = document.getElementById('time-estimate');
        
        const updateAnalytics = () => {
            const text = textInput.value;
            const words = text.trim() === '' ? [] : text.trim().split(/\s+/);
            wordCountEl.textContent = words.length;
            charCountEl.textContent = text.length;
            const timeInSeconds = (words.length / 150) * 60;
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = Math.floor(timeInSeconds % 60);
            timeEstimateEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        textInput.addEventListener('input', updateAnalytics);
        updateAnalytics();
    }

    function showEditUserModal(user) {
        const modal = document.getElementById('edit-user-modal');
        const form = document.getElementById('edit-user-form');
        const feedbackEl = document.getElementById('edit-user-feedback');
        
        feedbackEl.textContent = '';
        document.getElementById('edit-user-id').value = user.id;
        document.getElementById('edit-user-email').value = user.email;
        document.getElementById('edit-user-whatsapp').value = user.whatsapp || '';
        
        modal.style.display = 'flex';

        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('edit-user-id').value;
            const newEmail = document.getElementById('edit-user-email').value;
            const newWhatsapp = document.getElementById('edit-user-whatsapp').value;
            
            try {
                await apiRequest(`/api/admin/user/${userId}`, 'PUT', { email: newEmail, whatsapp: newWhatsapp });
                showSuccessToast('Utilizador atualizado com sucesso!');
                modal.style.display = 'none';
                initializeAdminPanel(); // Refresh the list
            } catch (error) {
                document.getElementById('edit-user-feedback').textContent = error.message;
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            modal.style.display = 'none';
        }, { once: true });
    }

    async function initializeAdminPanel() {
        const container = document.getElementById('admin-container');
        container.innerHTML = `<div class="card p-4 text-center">A carregar dados do painel...</div>`;

        try {
            const [stats, appStatus] = await Promise.all([ 
                apiRequest('/api/admin/stats', 'GET'),
                apiRequest('/api/status', 'GET')
            ]);
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Total</p><p class="text-3xl font-bold">${stats.totalUsers}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Online</p><p class="text-3xl font-bold text-green-600">${stats.onlineNow}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Logins (24h)</p><p class="text-3xl font-bold">${stats.loginsLast24h}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Pendentes</p><p class="text-3xl font-bold text-yellow-500">${stats.pendingActivation}</p></div>
                </div>

                <div class="card p-6 space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Modo Manuten√ß√£o</h3>
                        <div class="flex items-center gap-4">
                           <label class="switch"><input type="checkbox" id="maintenance-toggle" ${appStatus.maintenance.is_on ? 'checked' : ''}><span class="slider"></span></label>
                           <input type="text" id="maintenance-message-input" value="${appStatus.maintenance.message || ''}" class="flex-1 px-3 py-2 rounded-lg form-input" placeholder="Mensagem de manuten√ß√£o (opcional)">
                           <button id="save-maintenance" class="py-2 px-5 rounded-lg font-semibold primary-btn">Salvar</button>
                        </div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">An√∫ncio Global</h3>
                        <textarea id="announcement-message-input" class="w-full h-24 px-3 py-2 rounded-lg form-input" placeholder="Digite uma mensagem pop-up para todos os utilizadores online.">${appStatus.announcement?.message || ''}</textarea>
                        <div class="flex justify-end gap-2 mt-2">
                             <button id="clear-announcement" class="py-2 px-5 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-800">Limpar An√∫ncio</button>
                             <button id="send-announcement" class="py-2 px-5 rounded-lg font-semibold primary-btn">Enviar An√∫ncio</button>
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <h3 class="text-lg font-semibold mb-2">Buscar Utilizadores</h3>
                    <input type="text" id="admin-search-input" class="w-full px-3 py-2 rounded-lg form-input" placeholder="Buscar por e-mail ou WhatsApp...">
                </div>

                <div id="pending-users-container"></div>
                <div id="active-users-container"></div>
            `;
            
            await fetchAndRenderUsers('pending');
            await fetchAndRenderUsers('active');

            document.getElementById('admin-search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                document.querySelectorAll('#admin-container table tbody tr').forEach(row => {
                    const email = row.cells[0].textContent.toLowerCase();
                    const whatsapp = row.cells[1].textContent.toLowerCase();
                    if (email.includes(searchTerm) || whatsapp.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            container.addEventListener('click', async (e) => {
                 if (e.target.matches('.edit-user-btn')) {
                    const user = {
                        id: e.target.dataset.userId,
                        email: e.target.dataset.userEmail,
                        whatsapp: e.target.dataset.userWhatsapp,
                    };
                    showEditUserModal(user);
                }
                 if (e.target.matches('.user-status-toggle')) {
                    const { userid, isActive } = e.target.dataset;
                    await apiRequest(`/api/admin/user/${userid}/status`, 'PUT', { isActive: isActive === 'true' });
                    initializeAdminPanel(); 
                }
                if (e.target.matches('.delete-user-btn')) {
                    const { userid, email } = e.target.dataset;
                    showConfirmationModal('Excluir Utilizador', `Tem a certeza de que deseja excluir ${email}?`, async () => {
                        await apiRequest(`/api/admin/user/${userid}`, 'DELETE');
                        initializeAdminPanel();
                    });
                }
                if (e.target.matches('.user-role-toggle')) {
                    const { userid, role, email } = e.target.dataset;
                    const actionText = role === 'admin' ? 'promover' : 'rebaixar';
                    const roleText = role === 'admin' ? 'Administrador' : 'Utilizador';
                    showConfirmationModal(`Alterar Cargo de Utilizador`, `Tem a certeza que deseja ${actionText} ${email} para o cargo de ${roleText}?`, async () => {
                        await apiRequest(`/api/admin/user/${userid}/role`, 'PUT', { role });
                        initializeAdminPanel(); 
                    });
                }
                if (e.target.id === 'approve-all-btn') {
                    showConfirmationModal('Aprovar Todos', `Tem a certeza de que deseja aprovar todos os utilizadores pendentes?`, async () => {
                         await apiRequest('/api/admin/approve-all', 'POST');
                         initializeAdminPanel();
                    });
                }
                if (e.target.id === 'save-maintenance') {
                    const is_on = document.getElementById('maintenance-toggle').checked;
                    const message = document.getElementById('maintenance-message-input').value;
                    await apiRequest('/api/admin/maintenance', 'POST', { is_on, message });
                    showSuccessToast('Modo de manuten√ß√£o salvo.');
                }
                if (e.target.id === 'send-announcement') {
                    const message = document.getElementById('announcement-message-input').value;
                    await apiRequest('/api/admin/announcement', 'POST', { message });
                    showSuccessToast('An√∫ncio enviado.');
                }
                if(e.target.id === 'clear-announcement') {
                    document.getElementById('announcement-message-input').value = '';
                    await apiRequest('/api/admin/announcement', 'POST', { message: '' });
                    showSuccessToast('An√∫ncio limpo.');
                }
            });

        } catch (error) {
            container.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
        }
    }

    async function fetchAndRenderUsers(status) {
        const { currentPage, limit } = appState.adminPanel[status];
        const response = await apiRequest(`/api/admin/users?status=${status}&page=${currentPage}&limit=${limit}`);
        
        const containerId = `${status}-users-container`;
        const container = document.getElementById(containerId);
        if (!container) return;

        const title = status === 'active' ? 'Utilizadores Ativos' : 'Utilizadores Pendentes';
        
        let tableHtml = '';
        if (response.data.length > 0) {
            tableHtml = `
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-left bg-gray-50">
                        <tr>
                            <th class="p-2 font-semibold">Email</th>
                            <th class="p-2 font-semibold">WhatsApp</th>
                            <th class="p-2 font-semibold">Cargo</th>
                            <th class="p-2 font-semibold">Data de Registro</th>
                            <th class="p-2 font-semibold">√öltimo Login</th>
                            <th class="p-2 font-semibold text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${response.data.map(u => {
                        const createdAt = u.created_at ? new Date(u.created_at).toLocaleString('pt-BR') : 'N/A';
                        const lastLoginAt = u.last_login_at ? new Date(u.last_login_at).toLocaleString('pt-BR') : 'Nunca';
                        
                        const whatsappNumber = u.whatsapp || '';
                        const cleanedWhatsapp = whatsappNumber.replace(/\D/g, '');
                        const whatsappLink = cleanedWhatsapp 
                            ? `<a href="https://wa.me/${cleanedWhatsapp}" target="_blank" class="text-blue-600 hover:underline">${whatsappNumber}</a>` 
                            : 'N/A';

                        let roleButton = '';
                        if (u.id !== 1 && u.id !== appState.currentUser.id) {
                            if (u.role === 'user') {
                                roleButton = `<button class="user-role-toggle text-xs font-medium text-blue-600 hover:underline" data-userid="${u.id}" data-role="admin" data-email="${u.email}">Tornar Admin</button>`;
                            } else {
                                roleButton = `<button class="user-role-toggle text-xs font-medium text-purple-600 hover:underline" data-userid="${u.id}" data-role="user" data-email="${u.email}">Remover Admin</button>`;
                            }
                        }

                        return `
                        <tr class="border-t">
                            <td class="p-2">${u.email}</td>
                            <td class="p-2">${whatsappLink}</td>
                            <td class="p-2 capitalize">${u.role}</td>
                            <td class="p-2">${createdAt}</td>
                            <td class="p-2">${lastLoginAt}</td>
                            <td class="p-2 space-x-2 text-right">
                                <button class="edit-user-btn text-xs font-medium text-blue-600 hover:underline" data-user-id="${u.id}" data-user-email="${u.email}" data-user-whatsapp="${u.whatsapp || ''}">Editar</button>
                                ${roleButton}
                                ${u.is_active ? 
                                  `<button class="user-status-toggle text-xs font-medium text-yellow-600 hover:underline" data-userid="${u.id}" data-is-active="false">Bloquear</button>` :
                                  `<button class="user-status-toggle text-xs font-medium text-green-600 hover:underline" data-userid="${u.id}" data-is-active="true">Ativar</button>`
                                }
                                <button class="delete-user-btn text-xs font-medium text-red-600 hover:underline" data-userid="${u.id}" data-email="${u.email}">Excluir</button>
                            </td>
                        </tr>`
                    }).join('')}
                    </tbody>
                </table>
            </div>`;
        } else {
            tableHtml = '<p class="text-sm text-gray-500 mt-2">Nenhum utilizador nesta categoria.</p>';
        }

        let paginationControls = '';
        if (response.totalPages > 1) {
             paginationControls = `<div class="flex justify-center items-center gap-2 mt-2">
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === 1 ? 'disabled' : ''} data-page="1" data-status="${status}">Primeira</button>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === 1 ? 'disabled' : ''} data-page="${response.currentPage - 1}" data-status="${status}">Anterior</button>
                <span class="text-sm text-gray-600">P√°gina ${response.currentPage} de ${response.totalPages}</span>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === response.totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === response.totalPages ? 'disabled' : ''} data-page="${response.currentPage + 1}" data-status="${status}">Pr√≥xima</button>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === response.totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === response.totalPages ? 'disabled' : ''} data-page="${response.totalPages}" data-status="${status}">√öltima</button>
             </div>`;
        }

        container.innerHTML = `
            <div class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">${title} (${response.total})</h3>
                    <div class="flex items-center gap-2">
                        ${status === 'pending' && response.total > 0 ? `<button id="approve-all-btn" class="text-xs font-semibold primary-btn py-1 px-3 rounded-md">Aprovar Todos</button>` : ''}
                        <label class="text-xs font-medium">Itens por p√°g:</label>
                        <select class="admin-limit-select text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" data-status="${status}">
                            <option value="10" ${limit === 10 ? 'selected' : ''}>10</option>
                            <option value="50" ${limit === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${limit === 100 ? 'selected' : ''}>100</option>
                        </select>
                    </div>
                </div>
                ${tableHtml}
                ${paginationControls}
            </div>
        `;
        
        container.querySelectorAll('.admin-limit-select, .card button[data-page]').forEach(el => {
            const eventType = el.tagName === 'SELECT' ? 'change' : 'click';
            el.addEventListener(eventType, (e) => {
                const status = e.currentTarget.dataset.status;
                if(e.currentTarget.classList.contains('admin-limit-select')){
                    appState.adminPanel[status].limit = parseInt(e.currentTarget.value);
                    appState.adminPanel[status].currentPage = 1;
                } else {
                    appState.adminPanel[status].currentPage = parseInt(e.currentTarget.dataset.page);
                }
                fetchAndRenderUsers(status);
            });
        });
    }

    // --- Session Persistence & Initial Load ---
    async function checkSession() {
        const token = localStorage.getItem('authToken');
        if (token) {
            try {
                const response = await apiRequest('/api/verify-session', 'GET');
                if (response && response.user) {
                    appState.currentUser = response.user;
                    const appStatus = await apiRequest('/api/status', 'GET');
                    if (appStatus && appStatus.maintenance && appStatus.maintenance.is_on && appState.currentUser.role !== 'admin') {
                        showMaintenanceMode(appStatus.maintenance.message);
                    } else {
                        await initializeApp(appStatus ? appStatus.announcement : null);
                    }
                } else {
                    handleLogout();
                }
            } catch (error) {
                console.error("Falha na verifica√ß√£o da sess√£o:", error);
                handleLogout();
            }
        } else {
            showScreen('auth-section');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', checkSession);
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('register-form').addEventListener('submit', handleRegister);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('logout-from-maintenance').addEventListener('click', handleLogout);
    document.getElementById('back-to-login').addEventListener('click', (e) => { e.preventDefault(); showScreen('auth-section'); });
    
    document.getElementById('show-register').addEventListener('click', () => {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('register-container').style.display = 'block';
    });
    document.getElementById('show-login').addEventListener('click', () => {
        document.getElementById('register-container').style.display = 'none';
        document.getElementById('login-container').style.display = 'block';
    });

    document.getElementById('sidebar-nav').addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    document.getElementById('close-api-alert-btn').addEventListener('click', () => {
        document.getElementById('api-alert-modal').style.display = 'none';
    });
    document.getElementById('go-to-settings-btn').addEventListener('click', () => {
        document.getElementById('api-alert-modal').style.display = 'none';
        const settingsButton = document.querySelector('.sidebar-btn[data-tab="settings"]');
        if (settingsButton) {
            settingsButton.click();
        }
    });

    document.getElementById('tab-content').addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn, .prompt-copy-btn');
        if (copyBtn) {
            const textToCopy = decodeURIComponent(copyBtn.dataset.copyText);
            navigator.clipboard.writeText(textToCopy).then(() => {
                showSuccessToast("Copiado para a √°rea de transfer√™ncia!");
            });
        }
        
        if (e.target.id === 'copy-script-btn' && scriptResults.fullResult) {
            navigator.clipboard.writeText(scriptResults.fullResult.full_script_text).then(() => {
                showSuccessToast("Roteiro copiado!");
            });
        }
        if (e.target.id === 'save-script-txt-btn' && scriptResults.fullResult) {
            const topic = document.getElementById('script-topic').value.trim() || 'roteiro';
            downloadFile(scriptResults.fullResult.full_script_text, topic.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.txt');
        }
        if (e.target.id === 'clear-script-output-btn') {
            document.getElementById('output').innerHTML = '';
            document.getElementById('script-pagination-controls').innerHTML = '';
            document.getElementById('script-writer-form-container').reset();
            document.getElementById('affiliate-product-container').style.display = 'none';
        }
        if (e.target.id === 'clear-history-btn') {
            showConfirmationModal('Limpar Hist√≥rico', 'Tem a certeza que deseja apagar todos os roteiros salvos?', () => {
                localStorage.removeItem('scriptHistory');
                renderScriptHistory();
                showSuccessToast('Hist√≥rico de roteiros limpo.');
            });
        }
        if (e.target.matches('.download-history-btn')) {
            const scriptId = parseInt(e.target.dataset.scriptId, 10);
            const history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');
            const scriptItem = history.find(item => item.id === scriptId);
            if (scriptItem) {
                downloadFile(scriptItem.data.full_script_text, scriptItem.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.txt');
            }
        }

        if (e.target.id === 'copy-all-scene-prompts') {
            navigator.clipboard.writeText(scenePromptResults.allPromptsText).then(() => {
                showSuccessToast("Todos os prompts foram copiados!");
            });
        }
        if (e.target.id === 'download-scene-prompts') {
            downloadFile(scenePromptResults.allPromptsText, 'prompts_de_cena.txt');
        }

        if (e.target.id === 'download-thumb-prompts') {
            downloadFile(thumbnailPromptResults.allPromptsText, 'prompts_de_thumbnail.txt');
        }
    });

    document.getElementById('open-menu-btn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('menu-overlay').style.display = 'block';
    });
    document.getElementById('menu-overlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menu-overlay').style.display = 'none';
    });

    </script>
</body>
</html>

