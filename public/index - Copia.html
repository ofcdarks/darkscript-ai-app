<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARKSCRIPT AI</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .font-display { font-weight: 700; }
        .sidebar-btn { 
            transition: all 0.2s ease-in-out; 
            color: #4b5563;
        }
        .sidebar-btn:hover { 
            background-color: #e5e7eb;
            color: #111827;
        }
        .sidebar-btn-active { 
            background-color: #3b82f6;
            color: white; 
            font-weight: 600; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .sidebar-divider {
            padding: 8px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .auth-container {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .form-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-input:focus-visible {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .primary-btn {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .primary-btn:hover {
            background-color: #2563eb;
        }
        .secondary-link { color: #3b82f6; }
        .secondary-link:hover { text-decoration: underline; }
        .card {
             background-color: #ffffff;
             border: 1px solid #e5e7eb;
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .copy-btn.copied, .prompt-copy-btn.copied { background-color: #10b981 !important; color: white !important; }
        .prompt-card.copied {
            background-color: #e6fef2;
            border-left-color: #10b981;
        }
        #log-bar {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:focus + .slider { box-shadow: 0 0 1px #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }


        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed; left: -100%; top: 0; height: 100%; z-index: 40;
                transition: left 0.3s ease-in-out; width: 288px;
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; }
            #menu-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5); z-index: 30;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Overlay de Manuten√ß√£o -->
    <div id="maintenance-overlay" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center text-center p-4">
        <div class="max-w-md text-white">
            <h2 class="text-3xl font-bold mb-2">Em Manuten√ß√£o</h2>
            <p id="maintenance-message" class="text-gray-300 mb-6">Estamos a realizar melhorias. Voltaremos em breve!</p>
            <button id="logout-from-maintenance" class="bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-4 rounded-lg">Sair</button>
        </div>
    </div>

    <!-- Overlay de An√∫ncio Global -->
    <div id="announcement-overlay" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9998] flex items-center justify-center p-4">
        <div class="max-w-md relative bg-white p-8 rounded-lg shadow-xl text-gray-800">
             <button id="close-announcement-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-blue-500 mb-2">Aviso Importante</h2>
            <p id="announcement-message" class="text-gray-600 whitespace-pre-wrap"></p>
        </div>
    </div>

    <!-- Tela de Ativa√ß√£o Pendente -->
    <div id="activation-container" style="display: none;" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 space-y-4 text-center rounded-xl auth-container">
            <h2 class="text-2xl font-bold text-gray-900">Ativa√ß√£o Pendente</h2>
            <p class="text-gray-600">A sua conta foi registada com sucesso, mas precisa de ser ativada por um administrador.</p>
            <p class="text-sm text-gray-500">Pode fechar esta p√°gina. Ser√° notificado por e-mail quando a sua conta for ativada.</p>
            <button id="back-to-login" class="text-sm secondary-link font-medium">Voltar para o Login</button>
        </div>
    </div>

    <!-- Telas de Autentica√ß√£o -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tight text-gray-900">DARKSCRIPT AI</h1>
                <p class="mt-1 text-gray-600">Intelig√™ncia para criadores.</p>
            </div>
            
            <div id="login-container" class="p-8 space-y-6 rounded-xl auth-container">
                <form id="login-form" class="space-y-6">
                    <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                    <input id="login-email" type="email" autocomplete="email" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Email">
                    <input id="login-password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Senha">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <input id="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="remember-me" class="text-gray-600">Lembrar-me</label>
                        </div>
                    </div>
                    <button type="submit" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Entrar</button>
                </form>
                <p class="text-center text-sm text-gray-500">N√£o tem uma conta? <button id="show-register" class="font-medium secondary-link">Registe-se</button></p>
            </div>

            <div id="register-container" class="p-8 space-y-6 rounded-xl auth-container" style="display: none;">
                <form id="register-form" class="space-y-6">
                    <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                    <input id="register-email" type="email" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Seu melhor e-mail">
                    <input id="register-password" type="password" required class="w-full px-4 py-3 rounded-lg form-input" placeholder="Crie uma senha forte">
                    <button type="submit" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Criar Conta</button>
                </form>
                <p class="text-center text-sm text-gray-500">J√° tem uma conta? <button id="show-login" class="font-medium secondary-link">Fa√ßa login</button></p>
            </div>
        </div>
    </div>
    
    <!-- Modal de Progresso -->
    <div id="progress-modal" style="display: none;" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="card p-6 text-center shadow-2xl">
            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="progress-phrase" class="text-sm text-gray-600 mt-2 font-medium">A processar...</p>
        </div>
    </div>
    
    <!-- Conte√∫do da Aplica√ß√£o -->
    <div id="app-container" style="display: none;" class="h-screen bg-gray-100">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white flex-shrink-0 flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-200 flex items-center gap-2 h-16">
                 <span class="text-2xl">üß†</span>
                 <span class="text-xl font-bold tracking-tight text-gray-900">DARKSCRIPT AI</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-2"></nav>
            <div class="p-4 border-t border-gray-200">
                <div class="p-2 rounded-lg bg-gray-100">
                    <p class="text-sm font-medium text-gray-800 truncate" id="user-email-display"></p>
                </div>
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-3 py-2 mt-2 rounded-lg text-gray-600 hover:bg-gray-200 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b border-gray-200 flex items-center h-16">
                <button id="open-menu-btn" class="text-2xl text-gray-600">‚ò∞</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg text-gray-900"></h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-8 overflow-y-auto"></main>
            <footer id="log-bar" class="p-2 text-xs text-center flex items-center justify-center h-8 border-t border-gray-200">
                <span id="log-message">Bem-vindo!</span>
            </footer>
        </div>
    </div>
    
    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmation-modal" style="display: none;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9997] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 id="confirmation-title" class="text-lg font-bold text-gray-900"></h3>
            <p id="confirmation-message" class="text-gray-600 my-4"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
    // --- Global State Management ---
    let appState = { 
        currentUser: null,
        adminPanel: {
            active: { currentPage: 1, limit: 10 },
            pending: { currentPage: 1, limit: 10 }
        }
    };
    
    // --- Utility Functions ---
    const showScreen = (screenId) => {
        ['auth-section', 'activation-container', 'app-container', 'maintenance-overlay'].forEach(id => {
            document.getElementById(id).style.display = (id === screenId) ? 'flex' : 'none';
        });
    };
    const showProgressModal = (phrase = 'A processar...') => {
        document.getElementById('progress-phrase').textContent = phrase;
        document.getElementById('progress-modal').style.display = 'flex';
    };
    const hideProgressModal = () => document.getElementById('progress-modal').style.display = 'none';
    const addToLog = (message, isError = false) => { 
        const logBar = document.getElementById('log-bar');
        document.getElementById('log-message').textContent = message; 
        logBar.style.backgroundColor = isError ? '#fee2e2' : '#dbeafe'; // red-100 or blue-100
        logBar.style.color = isError ? '#991b1b' : '#1e40af'; // red-800 or blue-800
    };


    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        const token = localStorage.getItem('authToken');
        const options = { 
            method, 
            headers: { 'Content-Type': 'application/json' } 
        };
        if (token) options.headers['Authorization'] = `Bearer ${token}`;
        if (body) options.body = JSON.stringify(body);
        
        const response = await fetch(endpoint, options);
        const data = await response.json().catch(() => null);
        
        if (!response.ok) {
            if ((response.status === 401 || response.status === 403) && endpoint !== '/api/login') {
                 if (!data || !data.message || !data.message.includes('ativada')) handleLogout();
            }
            throw new Error(data ? data.message : 'Ocorreu um erro desconhecido.');
        }
        return data;
    }

    // --- Authentication & Screen Navigation ---
    async function handleLogin(e) {
        e.preventDefault();
        document.getElementById('login-feedback').textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;
        try {
            const response = await apiRequest('/api/login', 'POST', { email, password, rememberMe });
            localStorage.setItem('authToken', response.token);
            appState.currentUser = response.user;

            const appStatus = await apiRequest('/api/status', 'GET');
            
            if (appStatus && appStatus.maintenance && appStatus.maintenance.is_on && appState.currentUser.role !== 'admin') {
                showMaintenanceMode(appStatus.maintenance.message);
            } else {
                await initializeApp(appStatus ? appStatus.announcement : null);
            }

        } catch (error) {
            if (error.message.includes('ativada')) {
                showScreen('activation-container');
            } else {
                document.getElementById('login-feedback').textContent = error.message;
            }
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        document.getElementById('register-feedback').textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            await apiRequest('/api/register', 'POST', { email, password });
            showScreen('activation-container');
        } catch (error)
        {
            document.getElementById('register-feedback').textContent = error.message;
        }
    }
    
    function handleLogout() {
        localStorage.removeItem('authToken');
        appState.currentUser = null;
        showScreen('auth-section');
        document.getElementById('login-form').reset();
    }
    
    function showMaintenanceMode(message) {
        document.getElementById('maintenance-message').textContent = message || 'Estamos a realizar melhorias na plataforma. Voltaremos em breve!';
        showScreen('maintenance-overlay');
    }

    function showAnnouncement(announcement) {
        if (!announcement || !announcement.message) return;
        const seenAnnouncements = JSON.parse(localStorage.getItem('seenAnnouncements') || '[]');
        const announcementHash = announcement.message.substring(0, 50);
        if (seenAnnouncements.includes(announcementHash)) return;

        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const linkedMessage = announcement.message.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-500 hover:underline">$1</a>');
        document.getElementById('announcement-message').innerHTML = linkedMessage;
        document.getElementById('announcement-overlay').style.display = 'flex';

        document.getElementById('close-announcement-btn').onclick = () => {
            document.getElementById('announcement-overlay').style.display = 'none';
            seenAnnouncements.push(announcementHash);
            localStorage.setItem('seenAnnouncements', JSON.stringify(seenAnnouncements));
        };
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        document.getElementById('confirmation-modal').style.display = 'flex';

        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        const confirmHandler = () => { onConfirm(); hideConfirmationModal(); };
        const cancelHandler = () => hideConfirmationModal();
        
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        
        document.getElementById('confirm-btn').addEventListener('click', confirmHandler);
        document.getElementById('cancel-btn').addEventListener('click', cancelHandler);
    }
    const hideConfirmationModal = () => document.getElementById('confirmation-modal').style.display = 'none';

    // --- App Initialization ---
    async function initializeApp(initialAnnouncement = null) {
        if (!appState.currentUser) return;
        
        document.getElementById('user-email-display').textContent = appState.currentUser.email;
        showScreen('app-container');
        
        buildSidebar();
        renderTabContent('script-writer');
        
        if(initialAnnouncement) showAnnouncement(initialAnnouncement);
    }

    // --- UI Building ---
    function buildSidebar() {
        const sidebarNav = document.getElementById('sidebar-nav');
        const navItems = [
            { type: 'divider', label: 'Cria√ß√£o e Conte√∫do' },
            { id: 'script-writer', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z', label: 'Criador de Roteiro' },
            { id: 'scene-prompts', icon: 'M15.5 4l-3.5 3.5M15.5 4a2.121 2.121 0 00-3-3L10 3.5M15.5 4v.5A2.5 2.5 0 0113 7M3 14l3-3m0 0l3 3m-3-3v10a2 2 0 002 2h3.5', label: 'Prompts para Cenas'},
            { id: 'thumbnail-prompts', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'Otimiza√ß√£o e Gest√£o' },
            { id: 'srt-converter', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4', label: 'Conversor de SRT' },
            { id: 'text-divider', icon: 'M4 6h16M4 12h16M4 18h7', label: 'Divisor de Texto' },
            { type: 'divider', label: 'Sistema' },
            { id: 'settings', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z', label: 'Configura√ß√µes' },
        ];
        if (appState.currentUser && appState.currentUser.role === 'admin') {
            navItems.push({ 
                id: 'admin', 
                icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-1.781-4.121M12 11a4 4 0 11-8 0 4 4 0 018 0z', 
                label: 'Painel Admin' 
            });
        }
        const createIcon = (path) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="${path}" /></svg>`;
        sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="sidebar-divider pt-4 pb-1">${item.label}</div>`;
            }
            return `<div class="px-4"><button class="sidebar-btn ${item.id === 'script-writer' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg" data-tab="${item.id}"><span>${createIcon(item.icon)}</span><span>${item.label}</span></button></div>`
        }).join('');
    }
    
    // --- Tools and Handlers ---
    const createCopyButton = (text, specificClass = '') => `<button class="copy-btn ${specificClass}" data-copy-text="${encodeURIComponent(text)}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>`;
    
    const getScoreColor = (score) => score >= 80 ? 'bg-blue-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-blue-600' : score >= 50 ? 'text-yellow-600' : 'text-red-600';
    
    const renderScoreCard = (title, mainScore, subScores, suggestion = '') => {
        const intMainScore = Math.round(mainScore || 0);
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            const cappedValue = Math.min(100, Math.round(value || 0));
            return `<div class="mb-2"><div class="flex justify-between items-center text-sm mb-1"><span class="text-gray-600">${key}</span><span class="font-semibold text-gray-700">${cappedValue}/100</span></div><div class="w-full bg-gray-200 rounded-full h-1.5"><div class="h-1.5 rounded-full ${getScoreColor(cappedValue)}" style="width: ${cappedValue}%;"></div></div></div>`;
        }).join('');
        const suggestionHtml = suggestion ? `<p class="text-xs text-gray-500 mt-3 pt-3 border-t"><strong class="text-gray-600">Virada de Chave:</strong> ${suggestion}</p>` : '';

        return `<div class="card p-4 w-full flex-shrink-0"><h4 class="font-semibold text-gray-800 mb-2">${title}</h4><div class="flex items-center justify-between mb-4"><div class="flex items-baseline gap-1"><span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span><span class="text-gray-500 text-sm">/ 100</span></div></div>${subScoresHtml}${suggestionHtml}</div>`;
    };

    const getLegendForTool = (toolId) => {
        const legends = {
            'script-writer': `<h4 class="font-semibold text-gray-800 mb-2">üí° Entendendo as M√©tricas</h4><ul class="space-y-2 text-sm text-gray-600 list-disc list-inside"><li><strong>Potencial de Reten√ß√£o:</strong> Mede a capacidade do roteiro de manter o espectador assistindo.</li><li><strong>Clareza da Mensagem:</strong> Avalia qu√£o f√°cil √© entender a ideia central do v√≠deo.</li><li><strong>Potencial Viral:</strong> Estima a probabilidade do conte√∫do ser amplamente compartilhado.</li></ul>`,
            'thumbnail-prompts': `<h4 class="font-semibold text-gray-800 mb-2">üí° Entendendo as M√©tricas</h4><ul class="space-y-2 text-sm text-gray-600 list-disc list-inside"><li><strong>Potencial de CTR:</strong> Estimativa do poder de atra√ß√£o do clique na thumbnail gerada.</li><li><strong>Virada de Chave:</strong> A principal melhoria ou conceito aplicado no prompt.</li></ul>`
        };
        const legendHtml = legends[toolId] || '';
        if (!legendHtml) return '';
        return `<div class="mt-6 text-sm card p-4">${legendHtml}</div>`;
    };

    async function callAIModel(prompt, schema = null) {
        showProgressModal('Analisando os alvos...');
        addToLog('Comunicando com a IA...');
        try {
            const result = await apiRequest('/api/generate', 'POST', { prompt, schema });
            addToLog(`An√°lise conclu√≠da via ${result.apiSource}.`);
            return result.data;
        } catch (error) {
            addToLog(`Erro na API: ${error.message}`, true);
            alert(`Erro na API: ${error.message}`);
            throw error;
        } finally {
            hideProgressModal();
        }
    }
    
    const tools = {
        "script-writer": { 
            title: "Criador de Roteiro", 
            desc: "Gere roteiros envolventes e otimizados para o seu canal.", 
            content: `<div class="max-w-3xl mx-auto">
                        <div class="card p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="script-niche" class="text-sm font-medium text-gray-700">Nicho do Canal</label>
                                    <input type="text" id="script-niche" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: Crimes Reais, Mist√©rios">
                                </div>
                                <div>
                                    <label for="script-audience" class="text-sm font-medium text-gray-700">P√∫blico-Alvo</label>
                                    <input type="text" id="script-audience" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: Jovens adultos, f√£s de suspense">
                                </div>
                            </div>
                            <div>
                                <label for="script-topic" class="text-sm font-medium text-gray-700">Tema do V√≠deo</label>
                                <input type="text" id="script-topic" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: O Mist√©rio do Tri√¢ngulo das Bermudas">
                            </div>
                            <div>
                                <label for="script-trends-term" class="text-sm font-medium text-gray-700">Termo de Pesquisa (Google Trends)</label>
                                <input type="text" id="script-trends-term" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: intelig√™ncia artificial, true crime brasil">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="script-duration" class="text-sm font-medium text-gray-700">Dura√ß√£o (minutos)</label>
                                    <input type="number" id="script-duration" class="mt-1 w-full px-4 py-3 rounded-lg form-input" placeholder="ex: 10">
                                </div>
                                <div>
                                    <label for="script-parts" class="text-sm font-medium text-gray-700">N√∫mero de Partes</label>
                                    <input type="number" id="script-parts" class="mt-1 w-full px-4 py-3 rounded-lg form-input bg-gray-200" placeholder="Auto" readonly>
                                </div>
                                <div>
                                    <label for="script-lang" class="text-sm font-medium text-gray-700">Idioma</label>
                                    <select id="script-lang" class="mt-1 w-full px-4 py-3 rounded-lg form-input">
                                        <option value="Portugu√™s (Brasil)">Portugu√™s (Brasil)</option>
                                        <option value="Ingl√™s">Ingl√™s</option>
                                        <option value="Espanhol">Espanhol</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-gray-700">Posi√ß√£o do CTA (Chamada para A√ß√£o)</label>
                                <div class="mt-2 flex items-center space-x-4">
                                    <div class="flex items-center"><input id="cta-inicio" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="cta-inicio" class="ml-2 text-sm">In√≠cio</label></div>
                                    <div class="flex items-center"><input id="cta-meio" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked><label for="cta-meio" class="ml-2 text-sm">Meio</label></div>
                                    <div class="flex items-center"><input id="cta-final" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="cta-final" class="ml-2 text-sm">Final</label></div>
                                </div>
                             </div>
                            <div class="flex items-center gap-2">
                               <input type="checkbox" id="script-narration" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                               <label for="script-narration" class="text-sm text-gray-700">Apenas Narra√ß√£o (para Voice Over)</label>
                            </div>
                            <button id="generate-script" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Roteiro</button>
                        </div>
                        <div id="legend-container" class="mt-6"></div>
                        <div id="output" class="mt-6"></div>
                        <div id="script-pagination-controls" class="flex justify-center items-center gap-4 mt-4"></div>
                      </div>` 
        },
        "scene-prompts": { title: "Prompts para Cenas", desc: "Gere prompts de imagem para o seu roteiro, de forma autom√°tica ou manual.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><div class="relative"><textarea id="scene-text" class="w-full h-40 px-4 py-3 rounded-lg form-input" placeholder="Cole o roteiro completo aqui..."></textarea><div id="scene-word-counter" class="absolute bottom-2 right-3 text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">0 palavras</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="scene-platform" class="w-full px-4 py-3 rounded-lg form-input"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Freepik">Freepik</option></select><select id="generation-mode" class="w-full px-4 py-3 rounded-lg form-input"><option value="auto">Gera√ß√£o Autom√°tica de Cenas</option><option value="manual">Gera√ß√£o Manual por Palavras</option></select></div><div id="manual-options" class="hidden items-center gap-2"><label class="text-sm">Gerar a cada</label><input type="number" value="100" id="scene-word-count" class="form-input w-20 text-center"><label class="text-sm">palavras.</label><span id="scene-preview" class="text-sm font-medium text-blue-600"></span></div><button id="generate-scene-prompts" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Prompts de Cena</button></div><div id="output" class="mt-6 space-y-4"></div><div id="scene-pagination-controls" class="flex justify-center items-center gap-4 mt-4"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 rounded-lg form-input" placeholder="T√≠tulo do V√≠deo"><select id="thumb-platform" class="w-full px-4 py-3 rounded-lg form-input"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Freepik">Freepik</option></select><button id="generate-prompts" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Gerar Prompts</button></div><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-prompts" style="display:none;" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Gerar Mais</button></div>` },
        "srt-converter": { title: "Conversor de SRT", desc: "Converta texto para o formato de legenda .SRT.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6 space-y-4"><textarea id="srt-input-text" class="w-full h-40 px-4 py-3 rounded-lg form-input" placeholder="Cole o texto completo aqui..."></textarea><div class="flex items-center gap-4 justify-center"><label for="srt-char-limit" class="text-sm font-medium text-gray-700">Limite de Caracteres (Autom√°tico: 500):</label><input type="number" id="srt-char-limit" class="form-input w-24 text-center" value="500"></div><button id="convert-to-srt" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Converter para SRT</button></div><div id="output" class="mt-6"></div></div>` },
        "text-divider": { title: "Divisor de Texto", desc: "Analise seu roteiro e divida-o em partes menores para facilitar a narra√ß√£o.", content: `<div class="max-w-3xl mx-auto"><div class="card p-6"><div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6"><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Palavras</p><p id="word-count" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Caracteres</p><p id="char-count" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-sm text-gray-500">Tempo de Narra√ß√£o</p><p id="time-estimate" class="text-3xl font-bold">00:00</p></div></div><textarea id="text-divider-input" class="w-full h-40 px-4 py-3 rounded-lg form-input mb-4" placeholder="Cole o roteiro completo aqui..."></textarea><div class="flex flex-wrap items-center justify-center gap-4"><label for="split-chunk-size" class="text-sm">Dividir a cada</label><input type="number" id="split-chunk-size" class="px-3 py-2 rounded-lg form-input w-24 text-center" value="150"><select id="split-chunk-type" class="px-3 py-2 rounded-lg form-input"><option value="word">palavras</option><option value="char">caracteres</option></select><button id="split-text-btn" class="py-2 px-6 rounded-lg font-semibold primary-btn">Dividir</button></div></div><div id="output" class="mt-6 space-y-4"></div></div>` },
        "settings": { title: "Configura√ß√µes", desc: "Gerencie e valide as suas chaves de API.", content: `<div class="max-w-3xl mx-auto card p-6 space-y-6"><h3 class="text-lg font-semibold">Chaves de API</h3><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">OpenAI API Key (Preferencial) <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline text-xs">(obter)</a></label><input type="password" id="openai-key" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div><hr/><div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Principal) <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline text-xs">(obter)</a></label><input type="password" id="gemini-key-1" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div><div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Reserva 1)</label><input type="password" id="gemini-key-2" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div><div><label class="block text-sm font-medium text-gray-700">Gemini API Key (Reserva 2)</label><input type="password" id="gemini-key-3" class="mt-1 block w-full px-3 py-2 rounded-lg form-input"></div></div><button id="save-settings" class="w-full justify-center py-3 px-4 rounded-lg font-semibold primary-btn">Salvar Configura√ß√µes</button><div id="settings-feedback" class="mt-2 text-sm"></div></div>` },
        "admin": { title: "Painel Administrativo", desc: "Gerir utilizadores e configura√ß√µes da aplica√ß√£o.", content: `<div id="admin-container" class="space-y-6"></div>` }
    };
    
    let scriptResults = {
        fullResult: null,
        currentPage: 1,
        partsPerPage: 10
    };

    let scenePromptResults = {
        data: [],
        currentPage: 1,
        scenesPerPage: 10
    };

    function renderScriptPage() {
        const output = document.getElementById('output');
        const controlsContainer = document.getElementById('script-pagination-controls');
        output.innerHTML = '';
        if (controlsContainer) controlsContainer.innerHTML = '';

        const { fullResult, currentPage, partsPerPage } = scriptResults;

        if (!fullResult || !fullResult.script_parts || fullResult.script_parts.length === 0) {
            output.innerHTML = '<div class="card p-4 text-center text-gray-500">Nenhum roteiro gerado.</div>';
            return;
        }

        const parts = fullResult.script_parts;
        const totalPages = Math.ceil(parts.length / partsPerPage);

        let scoreCardsHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">${renderScoreCard('Potencial de Reten√ß√£o', fullResult.scores.retention_potential, { 'Engajamento': fullResult.scores.retention_potential })}${renderScoreCard('Clareza da Mensagem', fullResult.scores.clarity_score, { 'Compreens√£o': fullResult.scores.clarity_score })}${renderScoreCard('Potencial Viral', fullResult.scores.viral_potential, { 'Compartilhamento': fullResult.scores.viral_potential })}</div>`;
        let actionButtonsHtml = `<div class="card p-4 mb-4 flex gap-4"><button id="copy-script-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-800">Copiar Roteiro Completo</button></div>`;

        const startIndex = (currentPage - 1) * partsPerPage;
        const endIndex = startIndex + partsPerPage;
        const paginatedParts = parts.slice(startIndex, endIndex);

        let scriptHtml = paginatedParts.map(part => `
            <div class="card mb-4">
                <div class="p-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg text-gray-800">${part.part_number}. ${part.part_title}</h3>
                        ${createCopyButton(part.part_content, 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}
                    </div>
                    <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4 mt-2">${part.part_content.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('')}</div>
                </div>
            </div>`).join('');
        
        output.innerHTML = scoreCardsHtml + actionButtonsHtml + scriptHtml;

        if (totalPages > 1 && controlsContainer) {
            let paginationHtml = '';
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Anterior</button>`;
            paginationHtml += `<span class="text-sm text-gray-600">P√°gina ${currentPage} de ${totalPages}</span>`;
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Pr√≥ximo</button>`;
            
            controlsContainer.innerHTML = paginationHtml;

            controlsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    scriptResults.currentPage = parseInt(e.currentTarget.dataset.page);
                    renderScriptPage();
                    output.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }
    }

    function renderScenePage() {
        const output = document.getElementById('output');
        const controlsContainer = document.getElementById('scene-pagination-controls');
        output.innerHTML = '';
        if(controlsContainer) controlsContainer.innerHTML = '';

        const { data, currentPage, scenesPerPage } = scenePromptResults;

        if (!data || data.length === 0) {
            output.innerHTML = '<div class="card p-4 text-center text-gray-500">Nenhuma cena gerada.</div>';
            return;
        }

        const startIndex = (currentPage - 1) * scenesPerPage;
        const endIndex = startIndex + scenesPerPage;
        const paginatedItems = data.slice(startIndex, endIndex);

        const allPromptsText = data.map(p => p.prompt_text).join('\n\n');

        const scenesHtml = paginatedItems.map((item, index) => `
            <div class="prompt-card card p-4 border-l-4 border-gray-200 transition-colors">
                ${item.original_text ? `<blockquote class="border-l-4 border-gray-300 pl-4 py-2 mb-3 bg-gray-50 italic text-sm text-gray-600"><p>"${item.original_text}..."</p></blockquote>` : ''}
                <div class="flex justify-between items-start">
                     <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">Cena ${startIndex + index + 1}: ${item.scene_description}</h4>
                        <p class="font-mono text-sm text-gray-700 mt-2 bg-gray-100 p-2 rounded">${item.prompt_text}</p>
                     </div>
                     <button class="prompt-copy-btn ml-4 p-2 rounded-md bg-gray-200 hover:bg-gray-300" data-copy-text="${encodeURIComponent(item.prompt_text)}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                     </button>
                </div>
            </div>`).join('');
        
        const headerHtml = `
            <div class="card p-4 mb-4">
                <button id="copy-all-scene-prompts" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-800">Copiar Todos os ${data.length} Prompts</button>
            </div>`;

        output.innerHTML = headerHtml + scenesHtml;

        document.getElementById('copy-all-scene-prompts').addEventListener('click', (e) => {
            const btn = e.currentTarget;
            navigator.clipboard.writeText(allPromptsText).then(() => {
                btn.textContent = 'Copiado!';
                btn.classList.add('copied');
                setTimeout(() => { 
                    btn.textContent = `Copiar Todos os ${data.length} Prompts`; 
                    btn.classList.remove('copied');
                }, 2000);
            });
        });

        const totalPages = Math.ceil(data.length / scenesPerPage);
        if (totalPages > 1 && controlsContainer) {
            let paginationHtml = '';
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Anterior</button>`;
            paginationHtml += `<span class="text-sm text-gray-600">P√°gina ${currentPage} de ${totalPages}</span>`;
            paginationHtml += `<button class="px-3 py-1 rounded-md text-sm font-medium ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Pr√≥ximo</button>`;
            
            controlsContainer.innerHTML = paginationHtml;

            controlsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    scenePromptResults.currentPage = parseInt(e.currentTarget.dataset.page);
                    renderScenePage();
                    output.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }
    }


    const handlers = {
        'generate-script': async (output) => {
            const niche = document.getElementById('script-niche').value.trim();
            const audience = document.getElementById('script-audience').value.trim();
            const topic = document.getElementById('script-topic').value.trim();
            const trendsTerm = document.getElementById('script-trends-term').value.trim();
            const duration = document.getElementById('script-duration').value;
            const narrationOnly = document.getElementById('script-narration').checked;
            const lang = document.getElementById('script-lang').value;
            const ctaPositions = Array.from(document.querySelectorAll('[id^="cta-"]:checked')).map(cb => cb.id.replace('cta-', ''));

            if (!topic || !duration || !niche || !audience) {
                alert("Por favor, preencha todos os campos obrigat√≥rios.");
                return;
            }

            const parts = document.getElementById('script-parts').value;
            const trendsLine = trendsTerm ? `- Termo de Pesquisa (Google Trends): ${trendsTerm} (use este termo para guiar o conte√∫do e torn√°-lo relevante para as pesquisas atuais)\n` : '';

            let prompt = `Como um roteirista MESTRE, especialista em engenharia reversa de v√≠deos virais para o YouTube e neuroci√™ncia do engajamento, sua miss√£o √© criar um roteiro EXCEPCIONALMENTE MAGN√âTICO no idioma "${lang}".

                INFORMA√á√ïES BASE:
                - Nicho do Canal: ${niche}
                - P√∫blico-Alvo: ${audience} (Descreva seus medos, desejos e curiosidades)
                - Tema do V√≠deo: ${topic}
                ${trendsLine}- Dura√ß√£o Alvo: ${duration} minutos

                REGRAS ESTRUTURAIS CR√çTICAS (N√ÉO NEGLIGENCIAR):
                1.  **Estrutura de Partes:** O roteiro ser√° dividido em ${parts} partes. CADA parte deve conter EXATAMENTE 5 par√°grafos.
                2.  **Contagem de Palavras:** Cada parte deve ter um total de **360 palavras**. Mantenha a contagem de palavras consistente para todas as partes, exceto a √∫ltima, que pode ser mais curta.
                3.  **T√©cnica de Narra√ß√£o:** ${narrationOnly ? "O texto deve ser 100% narra√ß√£o pura, pronta para voice-over, sem nenhuma indica√ß√£o de personagem ou di√°logo." : "O roteiro deve incluir narra√ß√£o e descri√ß√µes visuais concisas."}
                4.  **CTAs Estrat√©gicos:** Inclua Chamadas para A√ß√£o (CTAs) de forma org√¢nica e persuasiva nas seguintes se√ß√µes: ${ctaPositions.length > 0 ? ctaPositions.join(', ') : 'meio'}.

                GATILHOS PSICOL√ìGICOS A SEREM EMBUTIDOS:
                -   **Hook Inicial (Primeiros 15 segundos):** Comece com uma pergunta chocante, uma afirma√ß√£o contraintuitiva ou uma promessa de revela√ß√£o que gere CURIOSIDADE extrema.
                -   **Loops Abertos:** Constantemente introduza mist√©rios ou perguntas que s√≥ ser√£o respondidas mais tarde no v√≠deo para manter a TENS√ÉO.
                -   **Prova Social e Autoridade:** Incorpore dados, cita√ß√µes ou refer√™ncias que validem a informa√ß√£o.
                -   **Conex√£o Emocional:** Use storytelling para criar empatia e conectar-se com as emo√ß√µes do p√∫blico-alvo.
                -   **Antecipa√ß√£o:** Crie expectativa para a conclus√£o ou para a "grande revela√ß√£o" no final.

                REGRAS DE SA√çDA (FORMATO JSON OBRIGAT√ìRIO):
                1.  Avalie o roteiro final e forne√ßa 3 pontua√ß√µes (0-100) com base em seu potencial: 'Potencial de Reten√ß√£o', 'Clareza da Mensagem' e 'Potencial Viral'.
                2.  Crie um campo 'full_script_text' com o roteiro completo, concatenado, para c√≥pia f√°cil.
                3.  Estruture a sa√≠da no campo 'script_parts' como um array de objetos, onde cada objeto representa uma parte e cont√©m 'part_number', 'part_title' e 'part_content'.
            `;
            
            const schema = {
                type: "OBJECT", properties: {
                    scores: { type: "OBJECT", properties: { retention_potential: { type: "NUMBER" }, clarity_score: { type: "NUMBER" }, viral_potential: { type: "NUMBER" } } },
                    full_script_text: { type: "STRING" },
                    script_parts: { type: "ARRAY", items: { type: "OBJECT", properties: { part_number: { type: "NUMBER" }, part_title: { type: "STRING" }, part_content: { type: "STRING" } } } }
                }
            };
            
            const result = await callAIModel(prompt, schema);
            scriptResults.fullResult = result;
            scriptResults.currentPage = 1;

            document.getElementById('legend-container').innerHTML = getLegendForTool('script-writer');
            renderScriptPage();
        },
        'generate-scene-prompts': async(output) => {
            const text = document.getElementById('scene-text').value.trim();
            const platform = document.getElementById('scene-platform').value;
            const mode = document.getElementById('generation-mode').value;
            const wordCount = document.getElementById('scene-word-count').value;

            if (!text) { alert("Por favor, cole um roteiro."); return; }
            
            let chunks = [];
            const words = text.split(/\s+/).filter(Boolean);

            if (mode === 'manual') {
                 const step = parseInt(wordCount, 10);
                 for (let i = 0; i < words.length; i += step) {
                    chunks.push(words.slice(i, i + step).join(' '));
                }
            } else { // modo autom√°tico
                chunks = [text];
            }

            let prompt;
            if (mode === 'auto') {
                 prompt = `Como um diretor de arte, analise o roteiro a seguir e gere prompts de imagem em INGL√äS para a IA '${platform}'. Identifique os momentos-chave e crie 2 prompts cinematogr√°ficos para cada cena importante. Para cada prompt, retorne tamb√©m o trecho EXATO do roteiro original que o inspirou no campo 'original_text'.\n\nROTEIRO:\n${chunks[0]}`;
            } else {
                 prompt = `Como um diretor de arte, sua tarefa √© processar os seguintes trechos de um roteiro. Para CADA trecho fornecido, gere EXATAMENTE 1 prompt de imagem cinematogr√°fico em INGL√äS para a IA '${platform}'. O n√∫mero de prompts gerados deve ser id√™ntico ao n√∫mero de trechos de texto (${chunks.length}). N√£o combine nem omita nenhum trecho. Para cada prompt, retorne tamb√©m o trecho EXATO do roteiro original que o inspirou no campo 'original_text'.\n\nTRECHOS DO ROTEIRO:\n${JSON.stringify(chunks)}`;
            }

            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { scene_description: {type: "STRING"}, prompt_text: { type: "STRING" }, original_text: {type: "STRING"}} } };
            const result = await callAIModel(prompt, schema);
            
            scenePromptResults.data = result;
            scenePromptResults.currentPage = 1;
            
            renderScenePage();
        },
        'generate-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { alert("Por favor, insira um t√≠tulo."); return; }

            const platformConfigs = {
                'Midjourney': 'Foque em composi√ß√£o cinematogr√°fica, use par√¢metros como --ar 16:9, --style raw, e descreva a ilumina√ß√£o (ex: volumetric lighting).',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k". Descreva a emo√ß√£o e a paleta de cores.',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de..."',
                'Freepik': 'Use termos comerciais e diretos. "Homem surpreso apontando para um gr√°fico, fundo de escrit√≥rio, estilo de foto de banco de imagem."'
            };

            const prompt = `Gere 2 prompts AVAN√áADOS em INGL√äS para a IA '${platform}' para uma thumbnail sobre "${title}". Siga esta diretriz: ${platformConfigs[platform]}. Para cada prompt, forne√ßa:
            1.  'score': uma pontua√ß√£o de potencial de CTR (0-100).
            2.  'suggestion': uma "virada de chave" (melhoria principal) em PORTUGU√äS, BEM CURTA, com no m√°ximo 5 linhas.`;
            
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } };
            
            const result = await callAIModel(prompt, schema);
            
            let html = result.map(item => `<div class="card p-4 flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-start"><p class="font-mono text-sm bg-gray-100 p-2 rounded flex-1">${item.prompt}</p>${createCopyButton(item.prompt, 'ml-2 p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}</div></div><div class="w-full md:w-56 flex-shrink-0">${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score, 'Clareza': item.score > 10 ? item.score - 5 : item.score }, item.suggestion)}</div></div>`).join('');
            
            if (append) {
                document.getElementById('output').insertAdjacentHTML('beforeend', html);
            } else {
                document.getElementById('legend-container').innerHTML = getLegendForTool('thumbnail-prompts');
                output.innerHTML = html;
            }
            document.getElementById('generate-more-prompts').style.display = 'block';
        },
        'convert-to-srt': (output) => {
            const text = document.getElementById('srt-input-text').value;
            const charLimit = parseInt(document.getElementById('srt-char-limit').value, 10);

            if (!text.trim() || isNaN(charLimit) || charLimit <= 0) {
                alert("Por favor, cole um texto e defina um limite de caracteres v√°lido.");
                return;
            }

            const chunks = [];
            let currentIndex = 0;
            const textLength = text.length;

            while (currentIndex < textLength) {
                let endIndex = currentIndex + charLimit;
                if (endIndex >= textLength) {
                    chunks.push(text.substring(currentIndex).trim());
                    break;
                }

                let potentialCutOff = text.substring(currentIndex, endIndex);
                let splitIndex = -1;

                const sentenceEndChars = /[.?!]/g;
                let lastMatch;
                while ((lastMatch = sentenceEndChars.exec(potentialCutOff)) !== null) {
                    splitIndex = lastMatch.index + 1;
                }

                if (splitIndex === -1) {
                    const lastSpace = potentialCutOff.lastIndexOf(' ');
                    if (lastSpace !== -1) {
                        splitIndex = lastSpace;
                    } else {
                        splitIndex = charLimit;
                    }
                }
                
                let chunk = text.substring(currentIndex, currentIndex + splitIndex).trim();
                if (chunk) {
                    chunks.push(chunk);
                }
                currentIndex += splitIndex;
            }

            let srtContent = "";
            let startTime = 0; // in seconds
            chunks.forEach((chunk, index) => {
                const wordsPerSecond = 3;
                const wordCount = chunk.split(/\s+/).filter(Boolean).length;
                const duration = Math.max(2, Math.ceil(wordCount / wordsPerSecond)); 

                const formatTime = (seconds) => {
                    return new Date(seconds * 1000).toISOString().substr(11, 12).replace('.', ',');
                };

                const start = formatTime(startTime);
                const end = formatTime(startTime + duration);
                
                srtContent += `${index + 1}\n${start} --> ${end}\n${chunk}\n\n`;
                
                startTime += duration + 10;
            });
            
             output.innerHTML = `<div class="card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold">Resultado SRT</h4>
                        <div class="flex gap-2">
                            <button id="download-srt-btn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Download</button>
                            <button id="clear-srt-btn" class="text-xs bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Limpar</button>
                        </div>
                    </div>
                    <pre id="srt-result-content" class="whitespace-pre-wrap text-sm bg-gray-50 p-2 rounded border max-h-72 overflow-y-auto">${srtContent.trim()}</pre>
                </div>`;
            
            document.getElementById('download-srt-btn').addEventListener('click', () => {
                const srtFinalContent = document.getElementById('srt-result-content').textContent;
                const blob = new Blob([srtFinalContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'legendas.srt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            document.getElementById('clear-srt-btn').addEventListener('click', () => {
                document.getElementById('srt-input-text').value = '';
                output.innerHTML = '';
            });
        },
        'split-text-btn': () => {
            const text = document.getElementById('text-divider-input').value.trim();
            const chunkSize = parseInt(document.getElementById('split-chunk-size').value, 10);
            const chunkType = document.getElementById('split-chunk-type').value;
            const outputEl = document.getElementById('output');
            if (!text || isNaN(chunkSize) || chunkSize <= 0) return;

            const parts = [];
            if (chunkType === 'word') {
                const words = text.split(/\s+/).filter(Boolean);
                for (let i = 0; i < words.length; i += chunkSize) {
                    parts.push(words.slice(i, i + chunkSize).join(' '));
                }
            } else { // by character
                for (let i = 0; i < text.length; i += chunkSize) {
                    parts.push(text.substring(i, i + chunkSize));
                }
            }
            outputEl.innerHTML = parts.map((part, index) => `<div class="card p-4 relative"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Parte ${index + 1}</h4>${createCopyButton(part, 'p-1 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300')}</div><p class="text-gray-700 bg-gray-50 p-2 rounded border">${part}</p></div>`).join('');
        }
    };
    
    // --- Main Render Function ---
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        document.getElementById('tab-content').innerHTML = `<div class="fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-1">${tool.title}</h2><p class="text-gray-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        document.getElementById('mobile-header-title').textContent = tool.title;
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menu-overlay').style.display = 'none';

        if (tabId === 'settings') initializeSettings();
        if (tabId === 'admin') initializeAdminPanel();
        if (tabId === 'text-divider') initializeTextDivider();
        if (tabId === 'script-writer') {
            document.getElementById('script-duration').addEventListener('input', e => {
                const duration = parseInt(e.target.value, 10);
                const partsInput = document.getElementById('script-parts');
                if (duration > 0) {
                    partsInput.value = Math.ceil(duration / 2.5);
                } else {
                    partsInput.value = '';
                }
            });
        }
        if (tabId === 'scene-prompts'){
           initializeScenePrompts();
        }

        const outputEl = document.getElementById('output');
        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', (e) => handlers[buttonId](outputEl, e));
            }
        });
        
        const morePromptsBtn = document.getElementById('generate-more-prompts');
        if(morePromptsBtn){
            morePromptsBtn.addEventListener('click', () => handlers['generate-prompts'](outputEl, true));
        }
    }

    // --- Specific Initializers ---
    function initializeScenePrompts() {
        const textInput = document.getElementById('scene-text');
        const wordCounter = document.getElementById('scene-word-counter');
        const modeSelector = document.getElementById('generation-mode');
        const manualOptions = document.getElementById('manual-options');
        const wordCountInput = document.getElementById('scene-word-count');
        const scenePreview = document.getElementById('scene-preview');

        const countWords = (text) => text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        
        const updatePreview = () => {
            const totalWords = countWords(textInput.value);
            const wordsPerScene = parseInt(wordCountInput.value, 10);
            if(totalWords > 0 && wordsPerScene > 0) {
                const sceneCount = Math.ceil(totalWords / wordsPerScene);
                scenePreview.textContent = `~ ${sceneCount} cenas ser√£o geradas.`;
            } else {
                scenePreview.textContent = '';
            }
        };

        textInput.addEventListener('input', () => {
            const totalWords = countWords(textInput.value);
            wordCounter.textContent = `${totalWords} palavras`;
            if (modeSelector.value === 'manual') {
                updatePreview();
            }
        });
        
        modeSelector.addEventListener('change', e => {
            const isManual = e.target.value === 'manual';
            manualOptions.style.display = isManual ? 'flex' : 'none';
            if(isManual) updatePreview(); else scenePreview.textContent = '';
        });

        wordCountInput.addEventListener('input', updatePreview);
    }

    function initializeSettings() {
        const openAIKeyInput = document.getElementById('openai-key');
        const geminiKeyInput1 = document.getElementById('gemini-key-1');
        const geminiKeyInput2 = document.getElementById('gemini-key-2');
        const geminiKeyInput3 = document.getElementById('gemini-key-3');
        const feedbackEl = document.getElementById('settings-feedback');

        apiRequest('/api/settings', 'GET').then(savedSettings => {
             openAIKeyInput.value = savedSettings.openai || '';
             if(Array.isArray(savedSettings.gemini)) {
                 geminiKeyInput1.value = savedSettings.gemini[0] || '';
                 geminiKeyInput2.value = savedSettings.gemini[1] || '';
                 geminiKeyInput3.value = savedSettings.gemini[2] || '';
             } else {
                 geminiKeyInput1.value = savedSettings.gemini || '';
             }
        });

        document.getElementById('save-settings').addEventListener('click', async () => {
            const settingsToSave = {
                openai: openAIKeyInput.value.trim(),
                gemini: [
                    geminiKeyInput1.value.trim(),
                    geminiKeyInput2.value.trim(),
                    geminiKeyInput3.value.trim()
                ]
            };
            try {
                await apiRequest('/api/settings', 'POST', { settings: settingsToSave });
                feedbackEl.textContent = 'Configura√ß√µes salvas com sucesso!';
                feedbackEl.className = 'text-green-600';
            } catch(e) {
                feedbackEl.textContent = 'Erro ao salvar no servidor.';
                feedbackEl.className = 'text-red-600';
            }
            setTimeout(() => feedbackEl.textContent = '', 3000);
        });
    }
    
    function initializeTextDivider() {
        const textInput = document.getElementById('text-divider-input');
        const wordCountEl = document.getElementById('word-count');
        const charCountEl = document.getElementById('char-count');
        const timeEstimateEl = document.getElementById('time-estimate');
        
        const updateAnalytics = () => {
            const text = textInput.value;
            const words = text.trim() === '' ? [] : text.trim().split(/\s+/);
            wordCountEl.textContent = words.length;
            charCountEl.textContent = text.length;
            const timeInSeconds = (words.length / 150) * 60;
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = Math.floor(timeInSeconds % 60);
            timeEstimateEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        textInput.addEventListener('input', updateAnalytics);
        updateAnalytics();
    }

    async function initializeAdminPanel() {
        const container = document.getElementById('admin-container');
        container.innerHTML = `<div class="card p-4 text-center">A carregar dados do painel...</div>`;

        try {
            const [stats, appStatus] = await Promise.all([ 
                apiRequest('/api/admin/stats', 'GET'),
                apiRequest('/api/status', 'GET')
            ]);
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Total</p><p class="text-3xl font-bold">${stats.totalUsers}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Online</p><p class="text-3xl font-bold text-green-600">${stats.onlineNow}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Logins (24h)</p><p class="text-3xl font-bold">${stats.loginsLast24h}</p></div>
                    <div class="card p-4 text-center"><p class="text-sm text-gray-500">Pendentes</p><p class="text-3xl font-bold text-yellow-500">${stats.pendingActivation}</p></div>
                </div>

                <div class="card p-6 space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Modo Manuten√ß√£o</h3>
                        <div class="flex items-center gap-4">
                           <label class="switch"><input type="checkbox" id="maintenance-toggle" ${appStatus.maintenance.is_on ? 'checked' : ''}><span class="slider"></span></label>
                           <input type="text" id="maintenance-message-input" value="${appStatus.maintenance.message || ''}" class="flex-1 px-3 py-2 rounded-lg form-input" placeholder="Mensagem de manuten√ß√£o (opcional)">
                           <button id="save-maintenance" class="py-2 px-5 rounded-lg font-semibold primary-btn">Salvar</button>
                        </div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">An√∫ncio Global</h3>
                        <textarea id="announcement-message-input" class="w-full h-24 px-3 py-2 rounded-lg form-input" placeholder="Digite uma mensagem pop-up para todos os utilizadores online.">${appStatus.announcement?.message || ''}</textarea>
                        <div class="flex justify-end gap-2 mt-2">
                             <button id="clear-announcement" class="py-2 px-5 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-800">Limpar An√∫ncio</button>
                             <button id="send-announcement" class="py-2 px-5 rounded-lg font-semibold primary-btn">Enviar An√∫ncio</button>
                        </div>
                    </div>
                </div>
                <div id="pending-users-container"></div>
                <div id="active-users-container"></div>
            `;
            
            await fetchAndRenderUsers('pending');
            await fetchAndRenderUsers('active');

            container.addEventListener('click', async (e) => {
                 if (e.target.matches('.user-status-toggle')) {
                    const { userid, isActive } = e.target.dataset;
                    await apiRequest(`/api/admin/user/${userid}/status`, 'PUT', { isActive: isActive === 'true' });
                    initializeAdminPanel(); // Recarrega todo o painel
                }
                if (e.target.matches('.delete-user-btn')) {
                    const { userid, email } = e.target.dataset;
                    showConfirmationModal('Excluir Utilizador', `Tem a certeza de que deseja excluir ${email}?`, async () => {
                        await apiRequest(`/api/admin/user/${userid}`, 'DELETE');
                        initializeAdminPanel();
                    });
                }
                if (e.target.matches('.user-role-toggle')) {
                    const { userid, role, email } = e.target.dataset;
                    const actionText = role === 'admin' ? 'promover' : 'rebaixar';
                    const roleText = role === 'admin' ? 'Administrador' : 'Utilizador';
                    showConfirmationModal(`Alterar Cargo de Utilizador`, `Tem a certeza que deseja ${actionText} ${email} para o cargo de ${roleText}?`, async () => {
                        await apiRequest(`/api/admin/user/${userid}/role`, 'PUT', { role });
                        initializeAdminPanel(); // Recarrega o painel
                    });
                }
                if (e.target.id === 'approve-all-btn') {
                    showConfirmationModal('Aprovar Todos', `Tem a certeza de que deseja aprovar todos os utilizadores pendentes?`, async () => {
                         await apiRequest('/api/admin/approve-all', 'POST');
                         initializeAdminPanel();
                    });
                }
                if (e.target.id === 'save-maintenance') {
                    const is_on = document.getElementById('maintenance-toggle').checked;
                    const message = document.getElementById('maintenance-message-input').value;
                    await apiRequest('/api/admin/maintenance', 'POST', { is_on, message });
                    addToLog('Modo de manuten√ß√£o salvo.');
                }
                if (e.target.id === 'send-announcement') {
                    const message = document.getElementById('announcement-message-input').value;
                    await apiRequest('/api/admin/announcement', 'POST', { message });
                    addToLog('An√∫ncio enviado.');
                }
                if(e.target.id === 'clear-announcement') {
                    document.getElementById('announcement-message-input').value = '';
                    await apiRequest('/api/admin/announcement', 'POST', { message: '' });
                    addToLog('An√∫ncio limpo.');
                }
            });

        } catch (error) {
            container.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
        }
    }

    async function fetchAndRenderUsers(status) {
        const { currentPage, limit } = appState.adminPanel[status];
        const response = await apiRequest(`/api/admin/users?status=${status}&page=${currentPage}&limit=${limit}`);
        
        const containerId = `${status}-users-container`;
        const container = document.getElementById(containerId);
        if (!container) return;

        const title = status === 'active' ? 'Utilizadores Ativos' : 'Utilizadores Pendentes';
        
        let tableHtml = '';
        if (response.data.length > 0) {
            tableHtml = `
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-left bg-gray-50">
                        <tr>
                            <th class="p-2 font-semibold">Email</th>
                            <th class="p-2 font-semibold">Cargo</th>
                            <th class="p-2 font-semibold">Data de Registro</th>
                            <th class="p-2 font-semibold">√öltimo Login</th>
                            <th class="p-2 font-semibold text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${response.data.map(u => {
                        const createdAt = u.created_at ? new Date(u.created_at).toLocaleString('pt-BR') : 'N/A';
                        const lastLoginAt = u.last_login_at ? new Date(u.last_login_at).toLocaleString('pt-BR') : 'Nunca';

                        let roleButton = '';
                        if (u.id !== 1 && u.id !== appState.currentUser.id) { // Cannot change main admin or self
                            if (u.role === 'user') {
                                roleButton = `<button class="user-role-toggle text-xs font-medium text-blue-600 hover:underline" data-userid="${u.id}" data-role="admin" data-email="${u.email}">Tornar Admin</button>`;
                            } else {
                                roleButton = `<button class="user-role-toggle text-xs font-medium text-purple-600 hover:underline" data-userid="${u.id}" data-role="user" data-email="${u.email}">Remover Admin</button>`;
                            }
                        }

                        return `
                        <tr class="border-t">
                            <td class="p-2">${u.email}</td>
                            <td class="p-2 capitalize">${u.role}</td>
                            <td class="p-2">${createdAt}</td>
                            <td class="p-2">${lastLoginAt}</td>
                            <td class="p-2 space-x-2 text-right">
                                ${roleButton}
                                ${u.is_active ? 
                                  `<button class="user-status-toggle text-xs font-medium text-yellow-600 hover:underline" data-userid="${u.id}" data-is-active="false">Bloquear</button>` :
                                  `<button class="user-status-toggle text-xs font-medium text-green-600 hover:underline" data-userid="${u.id}" data-is-active="true">Ativar</button>`
                                }
                                <button class="delete-user-btn text-xs font-medium text-red-600 hover:underline" data-userid="${u.id}" data-email="${u.email}">Excluir</button>
                            </td>
                        </tr>`
                    }).join('')}
                    </tbody>
                </table>
            </div>`;
        } else {
            tableHtml = '<p class="text-sm text-gray-500 mt-2">Nenhum utilizador nesta categoria.</p>';
        }

        let paginationControls = '';
        if (response.totalPages > 1) {
             paginationControls = `<div class="flex justify-center items-center gap-2 mt-2">
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === 1 ? 'disabled' : ''} data-page="1" data-status="${status}">Primeira</button>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === 1 ? 'disabled' : ''} data-page="${response.currentPage - 1}" data-status="${status}">Anterior</button>
                <span class="text-sm text-gray-600">P√°gina ${response.currentPage} de ${response.totalPages}</span>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === response.totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === response.totalPages ? 'disabled' : ''} data-page="${response.currentPage + 1}" data-status="${status}">Pr√≥xima</button>
                <button class="px-3 py-1 rounded-md text-sm font-medium ${response.currentPage === response.totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-100 shadow-sm'}" ${response.currentPage === response.totalPages ? 'disabled' : ''} data-page="${response.totalPages}" data-status="${status}">√öltima</button>
             </div>`;
        }

        container.innerHTML = `
            <div class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">${title} (${response.total})</h3>
                    <div class="flex items-center gap-2">
                        ${status === 'pending' && response.total > 0 ? `<button id="approve-all-btn" class="text-xs font-semibold primary-btn py-1 px-3 rounded-md">Aprovar Todos</button>` : ''}
                        <label class="text-xs font-medium">Itens por p√°g:</label>
                        <select class="admin-limit-select text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" data-status="${status}">
                            <option value="10" ${limit === 10 ? 'selected' : ''}>10</option>
                            <option value="50" ${limit === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${limit === 100 ? 'selected' : ''}>100</option>
                        </select>
                    </div>
                </div>
                ${tableHtml}
                ${paginationControls}
            </div>
        `;
        
        container.querySelectorAll('.admin-limit-select, .card button[data-page]').forEach(el => {
            const eventType = el.tagName === 'SELECT' ? 'change' : 'click';
            el.addEventListener(eventType, (e) => {
                const status = e.currentTarget.dataset.status;
                if(e.currentTarget.classList.contains('admin-limit-select')){
                    appState.adminPanel[status].limit = parseInt(e.currentTarget.value);
                    appState.adminPanel[status].currentPage = 1;
                } else {
                    appState.adminPanel[status].currentPage = parseInt(e.currentTarget.dataset.page);
                }
                fetchAndRenderUsers(status);
            });
        });
    }
    
    // --- Session Persistence & Initial Load ---
    async function checkSession() {
        const token = localStorage.getItem('authToken');
        if (token) {
            try {
                const response = await apiRequest('/api/verify-session', 'GET');
                if (response && response.user) {
                    appState.currentUser = response.user;
                    const appStatus = await apiRequest('/api/status', 'GET');
                    if (appStatus && appStatus.maintenance && appStatus.maintenance.is_on && appState.currentUser.role !== 'admin') {
                        showMaintenanceMode(appStatus.maintenance.message);
                    } else {
                        await initializeApp(appStatus ? appStatus.announcement : null);
                    }
                } else {
                    handleLogout();
                }
            } catch (error) {
                console.error("Falha na verifica√ß√£o da sess√£o:", error);
                handleLogout();
            }
        } else {
            showScreen('auth-section');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', checkSession);
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('register-form').addEventListener('submit', handleRegister);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('logout-from-maintenance').addEventListener('click', handleLogout);
    document.getElementById('back-to-login').addEventListener('click', (e) => { e.preventDefault(); showScreen('auth-section'); });
    
    document.getElementById('show-register').addEventListener('click', () => {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('register-container').style.display = 'block';
    });
    document.getElementById('show-login').addEventListener('click', () => {
        document.getElementById('register-container').style.display = 'none';
        document.getElementById('login-container').style.display = 'block';
    });

    document.getElementById('sidebar-nav').addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    document.getElementById('tab-content').addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn, .prompt-copy-btn');
        if (copyBtn) {
            const textToCopy = decodeURIComponent(copyBtn.dataset.copyText);
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalContent = copyBtn.innerHTML;
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                copyBtn.classList.add('copied');
                
                const promptCard = copyBtn.closest('.prompt-card');
                if (promptCard) {
                    promptCard.classList.add('copied');
                }

                setTimeout(() => { 
                    copyBtn.innerHTML = originalContent; 
                    copyBtn.classList.remove('copied');
                    if (promptCard) promptCard.classList.remove('copied');
                }, 2000);
            });
        }
        
        if (e.target.id === 'copy-script-btn' && scriptResults.fullResult) {
            navigator.clipboard.writeText(scriptResults.fullResult.full_script_text).then(() => {
                e.target.textContent = 'Roteiro Copiado!';
                e.target.classList.add('copied')
                setTimeout(() => { 
                    e.target.textContent = 'Copiar Roteiro Completo';
                    e.target.classList.remove('copied')
                 }, 2000);
            });
        }
    });

    document.getElementById('open-menu-btn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('menu-overlay').style.display = 'block';
    });
    document.getElementById('menu-overlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menu-overlay').style.display = 'none';
    });

    </script>
</body>
</html>

